<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chatbot AI học tập - THCS Nguyễn Tri Phương</title>
    
    <!-- Font & Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Quicksand:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- KaTeX for math rendering -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css">
    <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/contrib/auto-render.min.js"></script>
    
    <!-- Markdown parser -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    
    <!-- Firebase -->
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Quicksand:wght@400;500;600;700&display=swap');

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Quicksand', sans-serif;
            background: linear-gradient(135deg, #e0f7fa 0%, #bbdefb 100%);
            height: 100%;
            display: flex;
            flex-direction: column;
        }

        html {
            height: 100%;
        }

        .container {
            display: flex;
            flex-direction: column;
            height: 100%;
            width: 100%;
            padding: 0;
        }

        /* Header */
        .header {
            background-color: rgba(255, 255, 255, 0.95);
            box-shadow: 0 2px 15px rgba(0,0,0,0.1);
            backdrop-filter: blur(10px);
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            z-index: 1000;
            padding: 15px 0;
        }

        .nav-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .logo-container {
            display: flex;
            align-items: center;
            gap: 15px;
            cursor: pointer;
        }

        .logo {
            height: 50px;
            border-radius: 8px;
        }

        .school-name {
            font-size: 1.3em;
            font-weight: 700;
            color: #26a69a;
        }

        .web-name {
            font-size: 1.1em;
            font-weight: 600;
            color: #666;
            margin-left: 10px;
        }

        /* User Info Section */
        .user-section {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 8px 15px;
            background: #f8f9fa;
            border-radius: 25px;
            transition: all 0.3s;
        }

        .user-info:hover {
            background: #e9ecef;
        }

        .user-avatar {
            width: 35px;
            height: 35px;
            border-radius: 50%;
            background: linear-gradient(135deg, #26a69a, #4CAF50);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
            font-size: 0.9em;
        }

        .user-details {
            display: flex;
            flex-direction: column;
        }

        .user-name {
            font-weight: 600;
            color: #333;
            font-size: 0.9em;
        }

        .user-email {
            font-size: 0.8em;
            color: #666;
        }

        .logout-btn {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            padding: 10px 20px;
            border-radius: 25px;
            color: #666;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.9em;
            font-weight: 600;
        }

        .logout-btn:hover {
            background: #e9ecef;
            color: #333;
        }

        /* Main Content */
        .main-content {
            display: flex;
            flex: 1;
            overflow: hidden;
            position: relative;
            margin-top: 80px;
            height: calc(100% - 80px);
        }

        /* Sidebar */
        .sidebar {
            width: 250px;
            background: linear-gradient(145deg, #f0f4c3, #e6ee9c);
            border-right: 1px solid #dce775;
            display: flex;
            flex-direction: column;
            padding: 20px;
            overflow-y: auto;
            transition: transform 0.3s ease;
            z-index: 99;
        }

        .sidebar-toggle {
            display: none;
            position: fixed;
            top: 90px;
            left: 20px;
            background: linear-gradient(135deg, #4CAF50, #2E7D32);
            color: white;
            border: none;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            cursor: pointer;
            z-index: 101;
            align-items: center;
            justify-content: center;
            font-size: 1.2em;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
        }

        .sidebar-section {
            margin-bottom: 30px;
        }

        .sidebar-title {
            color: #689f38;
            font-size: 1.1em;
            font-weight: 600;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .subject-button {
            width: 100%;
            padding: 12px 15px;
            margin-bottom: 10px;
            background: linear-gradient(145deg, #c5e1a5, #aed581);
            border: none;
            border-radius: 10px;
            color: #333;
            text-align: left;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 10px;
            font-weight: 500;
        }

        .subject-button:hover {
            background: linear-gradient(145deg, #aed581, #9ccc65);
            transform: translateX(5px);
        }

        .subject-button.active {
            background: linear-gradient(145deg, #8bc34a, #7cb342);
            color: white;
            box-shadow: 0 4px 10px rgba(139, 195, 74, 0.3);
        }

        /* Chat Area */
        .chat-area {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: white;
            width: 100%;
        }

        .chat-header {
            padding: 20px;
            border-bottom: 1px solid #e0e0e0;
            background: linear-gradient(145deg, #ffffff, #f5f5f5);
        }

        .chat-header h2 {
            color: #333;
            font-size: 1.4em;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .chat-header-info {
            color: #666;
            font-size: 0.9em;
            margin-top: 5px;
        }

        .messages-container {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            background: linear-gradient(145deg, #ffffff, #f5f5f5);
        }

        .message {
            margin-bottom: 20px;
            max-width: 85%;
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .user-message {
            margin-left: auto;
        }

        .bot-message {
            margin-right: auto;
        }

        .message-content {
            padding: 15px 20px;
            border-radius: 20px;
            position: relative;
            word-wrap: break-word;
            line-height: 1.6;
            overflow-x: auto;
        }

        .user-message .message-content {
            background: linear-gradient(145deg, #007bff, #0056b3);
            color: white;
            border-bottom-right-radius: 5px;
        }

        .bot-message .message-content {
            background: linear-gradient(145deg, #e3f2fd, #bbdefb);
            color: #212121;
            border-bottom-left-radius: 5px;
            overflow-wrap: break-word;
        }

        /* Markdown Styling - CẢI THIỆN */
        .message-content h1,
        .message-content h2,
        .message-content h3,
        .message-content h4 {
            margin: 16px 0 10px 0;
            color: #2c3e50;
            font-weight: 600;
            font-family: 'Quicksand', sans-serif;
        }

        .message-content h1 { font-size: 1.4em; }
        .message-content h2 { font-size: 1.3em; }
        .message-content h3 { font-size: 1.2em; }
        .message-content h4 { font-size: 1.1em; }

        .message-content strong {
            font-weight: 700;
        }

        .message-content em {
            font-style: italic;
        }

        .message-content code {
            background: rgba(0, 0, 0, 0.05);
            padding: 2px 6px;
            border-radius: 4px;
            font-family: 'Courier New', Courier, monospace;
            font-size: 0.95em;
        }

        .message-content pre {
            background: #2d2d2d;
            color: #f8f8f2;
            padding: 12px;
            border-radius: 8px;
            overflow-x: auto;
            margin: 12px 0;
            font-family: 'Courier New', Courier, monospace;
            font-size: 0.9em;
        }

        .message-content pre code {
            background: transparent;
            padding: 0;
            color: inherit;
            font-size: inherit;
        }

        .message-content ul,
        .message-content ol {
            margin: 10px 0 10px 24px;
        }

        .message-content li {
            margin-bottom: 6px;
        }

        .message-content blockquote {
            border-left: 4px solid #4CAF50;
            padding-left: 16px;
            margin: 12px 0;
            color: #555;
            font-style: italic;
        }

        .message-content hr {
            border: none;
            border-top: 2px solid #e0e0e0;
            margin: 16px 0;
        }

        .message-content table {
            border-collapse: collapse;
            margin: 12px 0;
            width: 100%;
            font-size: 0.95em;
        }

        .message-content th,
        .message-content td {
            border: 1px solid #ddd;
            padding: 10px;
            text-align: left;
        }

        .message-content th {
            background-color: #f2f2f2;
            font-weight: 600;
        }

        /* KaTeX Styling - ĐỒNG BỘ VỚI FONT CHÍNH */
        .message-content .katex,
        .message-content .katex-display {
            font-family: 'Quicksand', sans-serif !important;
        }

        .katex {
            font-family: 'Quicksand', sans-serif !important;
        }

        .message-time {
            font-size: 0.8em;
            color: #999;
            margin-top: 5px;
            text-align: right;
        }

        .user-message .message-time {
            text-align: right;
        }

        .bot-message .message-time {
            text-align: left;
        }

        .file-attachment {
            margin-top: 10px;
            padding: 10px;
            background: rgba(255, 255, 255, 0.9);
            border-radius: 10px;
            border: 1px solid #dee2e6;
        }

        .file-attachment a {
            display: flex;
            align-items: center;
            gap: 10px;
            color: #007bff;
            text-decoration: none;
            font-weight: 500;
        }

        .file-attachment a:hover {
            text-decoration: underline;
        }

        .file-preview {
            max-width: 200px;
            max-height: 200px;
            border-radius: 8px;
            margin-top: 10px;
            border: 1px solid #dee2e6;
        }

        /* Input Area */
        .input-area {
            padding: 20px;
            border-top: 1px solid #e0e0e0;
            background: white;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .attachment-preview {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            padding: 10px;
            background: #f8f9fa;
            border-bottom: 1px solid #e9ecef;
            display: none;
        }

        .attachment-item {
            display: flex;
            align-items: center;
            gap: 8px;
            background: white;
            padding: 8px 12px;
            border-radius: 15px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            font-size: 0.9em;
        }

        .remove-attachment {
            background: none;
            border: none;
            color: #dc3545;
            cursor: pointer;
            font-size: 1.2em;
        }

        .file-input {
            display: none;
        }

        .file-button {
            background: #6c757d;
            color: white;
            border: none;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2em;
            transition: all 0.3s;
        }

        .file-button:hover {
            background: #5a6268;
            transform: translateY(-2px);
        }

        .message-input {
            flex: 1;
            padding: 15px 20px;
            border: 2px solid #c5e1a5;
            border-radius: 25px;
            font-size: 1em;
            transition: all 0.3s;
            font-family: 'Quicksand', sans-serif;
        }

        .message-input:focus {
            border-color: #8bc34a;
            outline: none;
            box-shadow: 0 0 0 3px rgba(139, 195, 74, 0.2);
        }

        .send-button {
            background: linear-gradient(145deg, #4CAF50, #2E7D32);
            color: white;
            border: none;
            width: 55px;
            height: 55px;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.3em;
            transition: all 0.3s;
        }

        .send-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(76, 175, 80, 0.3);
        }

        .send-button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .loading-dots {
            display: flex;
            gap: 5px;
        }

        .dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #666;
            animation: bounce 1.4s infinite ease-in-out both;
        }

        .dot:nth-child(1) { animation-delay: -0.32s; }
        .dot:nth-child(2) { animation-delay: -0.16s; }

        @keyframes bounce {
            0%, 80%, 100% { transform: scale(0); }
            40% { transform: scale(1); }
        }

        /* Responsive */
        @media (max-width: 768px) {
            .container {
                height: 100%;
            }
            
            .main-content {
                flex-direction: row;
                margin-top: 80px;
                height: calc(100% - 80px);
            }
            
            .sidebar-toggle {
                display: flex;
            }
            
            .sidebar {
                position: fixed;
                left: 0;
                top: 80px;
                height: calc(100% - 80px);
                z-index: 100;
                transform: translateX(-100%);
                box-shadow: 2px 0 10px rgba(0,0,0,0.1);
            }
            
            .sidebar.show {
                transform: translateX(0);
            }
            
            .sidebar-overlay {
                display: none;
                position: fixed;
                top: 80px;
                left: 0;
                width: 100%;
                height: calc(100% - 80px);
                background: rgba(0,0,0,0.5);
                z-index: 99;
            }
            
            .sidebar-overlay.show {
                display: block;
            }
            
            .chat-area {
                width: 100%;
            }
            
            .sidebar-section {
                margin-bottom: 15px;
            }
            
            .subject-button {
                padding: 10px;
                font-size: 0.9em;
            }
            
            .chat-header {
                padding: 15px;
            }
            
            .chat-header h2 {
                font-size: 1.2em;
            }
            
            .messages-container {
                padding: 15px;
            }
            
            .message {
                max-width: 90%;
            }
            
            .input-area {
                padding: 15px;
            }
            
            .file-button, .send-button {
                width: 45px;
                height: 45px;
            }
            
            .web-name {
                display: none;
            }
            
            .user-details {
                display: none;
            }
            
            .logout-btn span {
                display: none;
            }
            
            .nav-container {
                padding: 0 15px;
            }
            
            .logo {
                height: 40px;
            }
            
            .school-name {
                font-size: 1em;
            }
        }

        @media (max-width: 480px) {
            .nav-container {
                padding: 0 10px;
            }
            
            .logo {
                height: 35px;
            }
            
            .school-name {
                font-size: 0.9em;
            }
            
            .sidebar-title {
                font-size: 1em;
            }
            
            .subject-button {
                font-size: 0.85em;
            }
            
            .main-content {
                margin-top: 75px;
                height: calc(100% - 75px);
            }
            
            .sidebar {
                top: 75px;
                height: calc(100% - 75px);
            }
            
            .sidebar-overlay {
                top: 75px;
                height: calc(100% - 75px);
            }
            
            .sidebar-toggle {
                top: 85px;
            }
        }
    </style>
</head>
<body>
    <!-- Header -->
    <header class="header">
        <div class="nav-container">
            <!-- Logo và tên web -->
            <div class="logo-container" onclick="goToIndex()">
                <img src="https://via.placeholder.com/50x50?text=Logo" alt="Logo trường THCS Nguyễn Tri Phương" class="logo">
                <div>
                    <div class="school-name">THCS Nguyễn Tri Phương</div>
                    <div class="web-name">Hệ thống học tập AI</div>
                </div>
            </div>
            
            <!-- Thông tin người dùng -->
            <div class="user-section" id="userSection">
                <div class="user-info">
                    <div class="user-avatar" id="userAvatar">N</div>
                    <div class="user-details">
                        <div class="user-name" id="userName">Người dùng</div>
                        <div class="user-email" id="userEmail">hmtpum002@gmail.com</div>
                    </div>
                </div>
                <button onclick="logout()" class="logout-btn">
                    <i class="fas fa-sign-out-alt"></i>
                    <span>Đăng xuất</span>
                </button>
            </div>
        </div>
    </header>
    
    <!-- Main Content -->
    <div class="main-content">
        <!-- Sidebar Toggle Button (mobile only) -->
        <button class="sidebar-toggle" id="sidebarToggle">
            <i class="fas fa-bars" id="sidebarToggleIcon"></i>
        </button>
        
        <!-- Sidebar Overlay (mobile only) -->
        <div class="sidebar-overlay" id="sidebarOverlay"></div>
        
        <!-- Sidebar -->
        <div class="sidebar" id="sidebar">
            <div class="sidebar-section">
                <div class="sidebar-title">
                    <i class="fas fa-book-open"></i> Môn học
                </div>
                <button class="subject-button active" data-subject="toan-dai">
                    <i class="fas fa-calculator"></i> Toán Đại Số
                </button>
                <button class="subject-button" data-subject="toan-hinh">
                    <i class="fas fa-shapes"></i> Toán Hình Học
                </button>
                <button class="subject-button" data-subject="ngu-van">
                    <i class="fas fa-book"></i> Ngữ Văn
                </button>
            </div>
            
            <div class="sidebar-section">
                <div class="sidebar-title">
                    <i class="fas fa-flask"></i> Khoa học
                </div>
                <button class="subject-button" data-subject="khtn">
                    <i class="fas fa-atom"></i> KHTN
                </button>
                <button class="subject-button" data-subject="lich-su-dia-ly">
                    <i class="fas fa-map"></i> Lịch Sử & Địa Lý
                </button>
                <button class="subject-button" data-subject="cong-nghe">
                    <i class="fas fa-robot"></i> Công Nghệ
                </button>
            </div>
            
            <div class="sidebar-section">
                <div class="sidebar-title">
                    <i class="fas fa-language"></i> Ngôn ngữ
                </div>
                <button class="subject-button" data-subject="anh-van">
                    <i class="fas fa-globe"></i> Anh Văn
                </button>
                <button class="subject-button" data-subject="tin-hoc">
                    <i class="fas fa-laptop-code"></i> Tin Học
                </button>
            </div>
            
            <div class="sidebar-section">
                <div class="sidebar-title">
                    <i class="fas fa-users"></i> Khác
                </div>
                <button class="subject-button" data-subject="gdcd">
                    <i class="fas fa-balance-scale"></i> GDCD
                </button>
                <button class="subject-button" data-subject="hdtn-hn">
                    <i class="fas fa-hands-helping"></i> HĐTN - HN
                </button>
                <button class="subject-button" data-subject="stem">
                    <i class="fas fa-cogs"></i> STEM
                </button>
            </div>
        </div>
        
        <!-- Chat Area -->
        <div class="chat-area">
            <div class="chat-header">
                <h2><i class="fas fa-robot"></i> Chatbot AI học tập</h2>
                <div class="chat-header-info" id="subjectInfo">
                    Chào em! Thầy/cô sẵn sàng hỗ trợ em học môn <strong>Toán Đại Số</strong>. 
                    Em có thể hỏi bài, gửi file hoặc yêu cầu bài tập.
                </div>
            </div>
            
            <div class="messages-container" id="messagesContainer">
                <!-- Messages will be loaded here -->
                <div class="message bot-message">
                    <div class="message-content">Chào em! Thầy/cô là trợ lý AI học tập của trường THCS Nguyễn Tri Phương.<br>Em có thể hỏi bất cứ điều gì về môn <strong>Toán Đại Số</strong>,<br>gửi file bài tập, hoặc yêu cầu giải thích chi tiết.</div>
                    <div class="message-time" id="welcomeTime"></div>
                </div>
            </div>
            
            <!-- Attachment Preview -->
            <div class="attachment-preview" id="attachmentPreview"></div>
            
            <!-- Input Area -->
            <div class="input-area">
                <input type="file" id="fileInput" class="file-input" multiple accept=".jpg,.jpeg,.png,.gif,.pdf,.doc,.docx,.txt,.ppt,.pptx">
                <button class="file-button" onclick="document.getElementById('fileInput').click()">
                    <i class="fas fa-paperclip"></i>
                </button>
                
                <input type="text" class="message-input" id="messageInput" placeholder="Hỏi thầy/cô điều gì đó..." autocomplete="off">
                
                <button class="send-button" id="sendButton" onclick="sendMessage()">
                    <i class="fas fa-paper-plane"></i>
                </button>
            </div>
        </div>
    </div>

    <!-- Import Google Generative AI -->
    <script type="importmap">
        {
            "imports": {
                "@google/generative-ai": "https://esm.run/@google/generative-ai"
            }
        }
    </script>

    <script type="module">
        // Initialize modules
        import { GoogleGenerativeAI } from "@google/generative-ai";

        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyA7eSuNHa_QXFgC-KsCeCLY5MdL90_FZsQ",
            authDomain: "thuvienhoctap-b24ae.firebaseapp.com",
            projectId: "thuvienhoctap-b24ae",
            storageBucket: "thuvienhoctap-b24ae.appspot.com",
            messagingSenderId: "25688122219",
            appId: "1:25688122219:web:6ff91267b41968a23e622e"
        };

        // Initialize Firebase (chỉ khi cần)
        let firestoreInitialized = false;
        let auth, db;
        
        try {
            // Khởi tạo Firebase app
            if (!firebase.apps.length) {
                firebase.initializeApp(firebaseConfig);
            }
            
            // Chỉ khởi tạo auth và firestore khi cần
            auth = firebase.auth();
            db = firebase.firestore();
            firestoreInitialized = true;
            
            // Tối ưu cài đặt Firestore để giảm kết nối
            db.settings({
                cacheSizeBytes: firebase.firestore.CACHE_SIZE_UNLIMITED
            });
            
            // Bật persistence
            db.enablePersistence()
                .catch((err) => {
                    console.warn('Không thể bật persistence:', err.code);
                });
                
        } catch (error) {
            console.warn('Không thể khởi tạo Firebase, chế độ offline:', error);
            firestoreInitialized = false;
        }

        // Initialize Gemini AI
        const GEMINI_API_KEY = "I2KvIpFfUmO_NoGghLU9ZXp-_sDB4xftCySazIA".split("").reverse().join("");
        
        let genAI, model;
        try {
            genAI = new GoogleGenerativeAI(GEMINI_API_KEY);
            model = genAI.getGenerativeModel({ 
                model: "gemini-2.5-flash",
                generationConfig: {
                    temperature: 0.7,
                    topP: 0.8,
                    topK: 40,
                    maxOutputTokens: 2048,
                }
            });
            console.log('✅ Gemini AI đã được khởi tạo');
        } catch (error) {
            console.error("Lỗi khởi tạo Gemini:", error);
            model = null;
        }

        // DOM Elements
        const userSection = document.getElementById('userSection');
        const userAvatar = document.getElementById('userAvatar');
        const userName = document.getElementById('userName');
        const userEmail = document.getElementById('userEmail');
        const subjectInfo = document.getElementById('subjectInfo');
        const messagesContainer = document.getElementById('messagesContainer');
        const messageInput = document.getElementById('messageInput');
        const sendButton = document.getElementById('sendButton');
        const fileInput = document.getElementById('fileInput');
        const attachmentPreview = document.getElementById('attachmentPreview');
        const subjectButtons = document.querySelectorAll('.subject-button');
        const sidebar = document.getElementById('sidebar');
        const sidebarToggle = document.getElementById('sidebarToggle');
        const sidebarToggleIcon = document.getElementById('sidebarToggleIcon');
        const sidebarOverlay = document.getElementById('sidebarOverlay');
        const welcomeTime = document.getElementById('welcomeTime');

        // Set welcome message time
        if (welcomeTime) {
            const now = new Date();
            welcomeTime.textContent = now.toLocaleTimeString('vi-VN', { 
                hour: '2-digit', 
                minute: '2-digit' 
            });
        }

        // App State
        let currentUser = null;
        let currentSubject = 'toan-dai';
        let attachedFiles = [];
        let subjectKnowledge = {};
        let homeworkData = {};
        let chatHistory = [];
        let isProcessing = false;
        let firestoreListeners = [];

        // Subject definitions
        const subjects = {
            'toan-dai': { 
                name: 'Toán Đại Số', 
                icon: 'calculator',
                systemPrompt: "Bạn là giáo viên Toán Đại Số THCS. Hướng dẫn chi tiết, giải thích từng bước. Sử dụng LaTeX cho công thức toán: $công_thức$ cho inline và $$công_thức$$ cho display. Không tự bọc span."
            },
            'toan-hinh': { 
                name: 'Toán Hình Học', 
                icon: 'shapes',
                systemPrompt: "Bạn là giáo viên Toán Hình Học THCS. Mô tả hình vẽ chi tiết bằng lời. Giải thích các định lý, công thức. Sử dụng LaTeX cho công thức toán."
            },
            'ngu-van': { 
                name: 'Ngữ Văn', 
                icon: 'book',
                systemPrompt: "Bạn là giáo viên Ngữ Văn THCS. Phân tích tác phẩm, hướng dẫn viết văn. Chú trọng cảm thụ văn học."
            },
            'khtn': { 
                name: 'Khoa Học Tự Nhiên', 
                icon: 'atom',
                systemPrompt: "Bạn là giáo viên KHTN THCS. Giải thích hiện tượng khoa học. Sử dụng LaTeX cho công thức hóa học, vật lý."
            },
            'lich-su-dia-ly': { 
                name: 'Lịch Sử & Địa Lý', 
                icon: 'map',
                systemPrompt: "Bạn là giáo viên Lịch Sử & Địa Lý THCS. Cung cấp thông tin chính xác về sự kiện lịch sử và địa lý Việt Nam."
            },
            'cong-nghe': { 
                name: 'Công Nghệ', 
                icon: 'robot',
                systemPrompt: "Bạn là giáo viên Công Nghệ THCS. Hướng dẫn thực hành, an toàn lao động. Giải thích nguyên lý kỹ thuật."
            },
            'anh-van': { 
                name: 'Anh Văn', 
                icon: 'globe',
                systemPrompt: "Bạn là giáo viên tiếng Anh THCS. Sử dụng cả tiếng Anh và tiếng Việt. Giải thích ngữ pháp, từ vựng."
            },
            'tin-hoc': { 
                name: 'Tin Học', 
                icon: 'laptop-code',
                systemPrompt: "Bạn là giáo viên Tin Học THCS. Hướng dẫn lập trình, sử dụng phần mềm. Giải thích thuật toán đơn giản."
            },
            'gdcd': { 
                name: 'Giáo Dục Công Dân', 
                icon: 'balance-scale',
                systemPrompt: "Bạn là giáo viên GDCD THCS. Giải thích các quyền và nghĩa vụ công dân. Hướng dẫn ứng xử đạo đức."
            },
            'hdtn-hn': { 
                name: 'Hoạt Động Trải Nghiệm - Hướng Nghiệp', 
                icon: 'hands-helping',
                systemPrompt: "Bạn là giáo viên HĐTN-HN THCS. Hướng dẫn kỹ năng sống, định hướng nghề nghiệp."
            },
            'stem': { 
                name: 'STEM', 
                icon: 'cogs',
                systemPrompt: "Bạn là giáo viên STEM THCS. Tích hợp Khoa học, Công nghệ, Kỹ thuật và Toán học. Sử dụng LaTeX cho công thức."
            }
        };

        // Configure marked for markdown parsing
        marked.setOptions({
            breaks: true,
            gfm: true,
            headerIds: false
        });

        // Initialize user
        function initializeUser() {
            const userData = JSON.parse(localStorage.getItem('user') || '{}');
            
            if (userData.uid && !userData.isGuest) {
                // User is logged in
                currentUser = userData;
                const displayName = userData.displayName || 'Người dùng';
                const email = userData.email || '';
                const firstLetter = displayName.charAt(0).toUpperCase();
                
                userAvatar.textContent = firstLetter;
                userName.textContent = displayName;
                userEmail.textContent = email;
                
                userSection.innerHTML = `
                    <div class="user-info">
                        <div class="user-avatar">${firstLetter}</div>
                        <div class="user-details">
                            <div class="user-name">${displayName}</div>
                            ${email ? `<div class="user-email">${email}</div>` : ''}
                        </div>
                    </div>
                    <button onclick="logout()" class="logout-btn">
                        <i class="fas fa-sign-out-alt"></i>
                        <span>Đăng xuất</span>
                    </button>
                `;
            } else {
                // Guest user
                currentUser = {
                    uid: userData.uid || 'guest_' + Date.now(),
                    displayName: 'Khách',
                    isGuest: true
                };
                userSection.innerHTML = `
                    <a href="auth.html" class="logout-btn" style="text-decoration: none;">
                        <i class="fas fa-sign-in-alt"></i>
                        <span>Đăng nhập</span>
                    </a>
                `;
            }
            
            // Load chat history from sessionStorage
            const savedHistory = sessionStorage.getItem(`chatHistory_${currentUser.uid}_${currentSubject}`);
            if (savedHistory) {
                try {
                    chatHistory = JSON.parse(savedHistory);
                    displayChatHistory();
                } catch (error) {
                    console.error('Lỗi khi tải lịch sử chat:', error);
                    chatHistory = [];
                }
            }
        }

        // Save chat history
        function saveChatHistory() {
            try {
                sessionStorage.setItem(`chatHistory_${currentUser.uid}_${currentSubject}`, JSON.stringify(chatHistory));
            } catch (error) {
                console.error('Lỗi khi lưu lịch sử chat:', error);
            }
        }

        // Display chat history
        function displayChatHistory() {
            messagesContainer.innerHTML = '';
            
            // Add welcome message
            const now = new Date();
            const welcomeDiv = document.createElement('div');
            welcomeDiv.className = 'message bot-message';
            welcomeDiv.innerHTML = `
                <div class="message-content">Chào em! Thầy/cô là trợ lý AI học tập của trường THCS Nguyễn Tri Phương.<br>Em có thể hỏi bất cứ điều gì về môn <strong>${subjects[currentSubject].name}</strong>,<br>gửi file bài tập, hoặc yêu cầu giải thích chi tiết.</div>
                <div class="message-time">${now.toLocaleTimeString('vi-VN', { hour: '2-digit', minute: '2-digit' })}</div>
            `;
            messagesContainer.appendChild(welcomeDiv);
            
            // Add chat history
            chatHistory.forEach(item => {
                addMessageToDisplay(item.role, item.text, item.files || []);
            });
            
            // Render LaTeX trong toàn bộ messages container
            setTimeout(() => {
                renderMathInElement(messagesContainer, {
                    delimiters: [
                        { left: "$$", right: "$$", display: true },
                        { left: "$", right: "$", display: false }
                    ],
                    throwOnError: false,
                    output: 'html'
                });
            }, 100);
        }

        // Load subject knowledge from Firestore (chỉ khi cần)
        async function loadSubjectKnowledge() {
            if (!firestoreInitialized) return;
            
            try {
                const snapshot = await db.collection('subject_knowledge')
                    .where('subject', '==', currentSubject)
                    .limit(1)
                    .get();
                
                subjectKnowledge = {};
                
                snapshot.forEach(doc => {
                    const data = doc.data();
                    subjectKnowledge[currentSubject] = data.knowledge || '';
                });
                
                console.log(`✅ Đã tải kiến thức cho môn ${currentSubject}`);
            } catch (error) {
                console.warn('⚠ Không thể tải kiến thức từ Firestore:', error);
                subjectKnowledge = {};
            }
        }

        // Load homework data from Firestore (chỉ khi cần)
        async function loadHomeworkData() {
            if (!firestoreInitialized) return;
            
            try {
                const snapshot = await db.collection('homework')
                    .where('subject', '==', currentSubject)
                    .limit(5)
                    .get();
                
                homeworkData = {};
                homeworkData[currentSubject] = [];
                
                snapshot.forEach(doc => {
                    const data = doc.data();
                    homeworkData[currentSubject].push({
                        question: data.question,
                        answer: data.answer,
                        difficulty: data.difficulty || 'medium'
                    });
                });
                
                console.log(`✅ Đã tải bài tập cho môn ${currentSubject}`);
            } catch (error) {
                console.warn('⚠ Không thể tải bài tập từ Firestore:', error);
                homeworkData = {};
            }
        }

        // Clean up Firestore listeners
        function cleanupFirestoreListeners() {
            firestoreListeners.forEach(unsubscribe => {
                if (unsubscribe && typeof unsubscribe === 'function') {
                    unsubscribe();
                }
            });
            firestoreListeners = [];
        }

        // Select subject
        function selectSubject(subject) {
            // Save current chat history
            saveChatHistory();
            
            // Clean up listeners
            cleanupFirestoreListeners();
            
            // Update active button
            subjectButtons.forEach(btn => {
                btn.classList.toggle('active', btn.dataset.subject === subject);
            });
            
            // Update current subject
            currentSubject = subject;
            
            // Update subject info
            const subjectName = subjects[subject]?.name || subject;
            subjectInfo.innerHTML = `Chào em! Thầy/cô sẵn sàng hỗ trợ em học môn <strong>${subjectName}</strong>. 
                                   Em có thể hỏi bài, gửi file hoặc yêu cầu bài tập.`;
            
            // Load chat history for new subject
            const savedHistory = sessionStorage.getItem(`chatHistory_${currentUser.uid}_${currentSubject}`);
            if (savedHistory) {
                try {
                    chatHistory = JSON.parse(savedHistory);
                } catch (error) {
                    chatHistory = [];
                }
            } else {
                chatHistory = [];
            }
            
            // Load data for new subject
            loadSubjectKnowledge();
            loadHomeworkData();
            
            // Display chat history
            displayChatHistory();
            
            // Close sidebar on mobile
            if (window.innerWidth <= 768) {
                hideSidebar();
            }
        }

        // Process markdown và render LaTeX đúng cách
        function processMarkdown(text) {
            if (!text) return '';
            
            // Parse markdown
            let html = marked.parse(text);
            
            return html;
        }

        // Add message to display với markdown và LaTeX
        function addMessageToDisplay(sender, text, files = []) {
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${sender}-message`;
            
            const now = new Date();
            const timeString = now.toLocaleTimeString('vi-VN', { 
                hour: '2-digit', 
                minute: '2-digit' 
            });
            
            let fileHtml = '';
            if (files && files.length > 0) {
                fileHtml = '<div class="file-attachment">';
                files.forEach(file => {
                    if (file.type && file.type.startsWith('image/')) {
                        fileHtml += `
                            <div>
                                <a href="#" onclick="viewImage('${file.url}')">
                                    <i class="fas fa-image"></i> ${file.name}
                                </a>
                                <img src="${file.url}" alt="${file.name}" class="file-preview">
                            </div>
                        `;
                    } else {
                        const icon = getFileIcon(file.type, file.name);
                        fileHtml += `
                            <a href="${file.url}" download="${file.name}" target="_blank">
                                ${icon} ${file.name}
                            </a>
                        `;
                    }
                });
                fileHtml += '</div>';
            }
            
            // Process markdown cho bot messages
            let htmlContent = '';
            if (sender === 'bot') {
                htmlContent = processMarkdown(text);
            } else {
                htmlContent = text.replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/\n/g, '<br>');
            }
            
            messageDiv.innerHTML = `
                <div class="message-content">${htmlContent}${fileHtml}</div>
                <div class="message-time">${timeString}</div>
            `;
            
            messagesContainer.appendChild(messageDiv);
            
            // Render LaTeX trong message mới
            if (sender === 'bot') {
                setTimeout(() => {
                    renderMathInElement(messageDiv, {
                        delimiters: [
                            { left: "$$", right: "$$", display: true },
                            { left: "$", right: "$", display: false }
                        ],
                        throwOnError: false,
                        output: 'html'
                    });
                }, 50);
            }
            
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        // Add message và lưu vào history
        function addMessage(sender, text, files = []) {
            addMessageToDisplay(sender, text, files);
            
            // Lưu vào history
            chatHistory.push({
                role: sender,
                text: text,
                timestamp: new Date().toISOString(),
                files: files.map(f => ({ name: f.name, type: f.type, url: f.url }))
            });
            
            // Giới hạn lịch sử chat
            if (chatHistory.length > 50) {
                chatHistory = chatHistory.slice(-50);
            }
            
            saveChatHistory();
        }

        // Get file icon
        function getFileIcon(fileType, fileName) {
            if (fileType && fileType.startsWith('image/')) {
                return '<i class="fas fa-image"></i>';
            } else if (fileType === 'application/pdf') {
                return '<i class="fas fa-file-pdf"></i>';
            } else if (fileType && (fileType.includes('word') || fileName.endsWith('.doc') || fileName.endsWith('.docx'))) {
                return '<i class="fas fa-file-word"></i>';
            } else if (fileType && (fileType.includes('powerpoint') || fileName.endsWith('.ppt') || fileName.endsWith('.pptx'))) {
                return '<i class="fas fa-file-powerpoint"></i>';
            } else if (fileType === 'text/plain' || fileName.endsWith('.txt')) {
                return '<i class="fas fa-file-alt"></i>';
            } else {
                return '<i class="fas fa-file"></i>';
            }
        }

        // View image in modal
        function viewImage(url) {
            const modal = document.createElement('div');
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0,0,0,0.9);
                display: flex;
                align-items: center;
                justify-content: center;
                z-index: 10000;
                cursor: pointer;
            `;
            
            modal.innerHTML = `
                <div style="position: relative; max-width: 95vw; max-height: 95vh;">
                    <img src="${url}" style="max-width: 100%; max-height: 100%; border-radius: 10px; display: block;">
                    <button onclick="this.parentElement.parentElement.remove()" 
                            style="position: absolute; top: -40px; right: 0; background: #f44336; color: white; border: none; width: 40px; height: 40px; border-radius: 50%; cursor: pointer; font-size: 1.2em; display: flex; align-items: center; justify-content: center;">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            `;
            
            modal.addEventListener('click', function(e) {
                if (e.target === modal) {
                    modal.remove();
                }
            });
            
            document.body.appendChild(modal);
        }

        // File to base64
        function fileToBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = () => resolve(reader.result);
                reader.onerror = error => reject(error);
            });
        }

        // Handle file selection
        fileInput.addEventListener('change', (e) => {
            const files = Array.from(e.target.files);
            
            // Check file size (max 5MB)
            const maxSize = 5 * 1024 * 1024;
            const validFiles = files.filter(file => file.size <= maxSize);
            
            if (validFiles.length < files.length) {
                showNotification('Một số file vượt quá giới hạn 5MB và đã bị bỏ qua.', 'warning');
            }
            
            // Add valid files
            validFiles.forEach(file => {
                attachedFiles.push(file);
                addAttachmentPreview(file);
            });
            
            // Show preview
            if (attachedFiles.length > 0) {
                attachmentPreview.style.display = 'flex';
            }
            
            // Reset input
            fileInput.value = '';
        });

        // Add attachment preview
        function addAttachmentPreview(file) {
            const attachmentItem = document.createElement('div');
            attachmentItem.className = 'attachment-item';
            
            const icon = getFileIcon(file.type, file.name);
            const fileName = file.name.length > 20 ? file.name.substring(0, 17) + '...' : file.name;
            
            attachmentItem.innerHTML = `
                ${icon}
                <span>${fileName}</span>
                <button class="remove-attachment" onclick="removeAttachment(${attachedFiles.length - 1})">
                    <i class="fas fa-times"></i>
                </button>
            `;
            
            attachmentPreview.appendChild(attachmentItem);
        }

        // Remove attachment
        function removeAttachment(index) {
            attachedFiles.splice(index, 1);
            updateAttachmentPreview();
        }

        // Update attachment preview
        function updateAttachmentPreview() {
            attachmentPreview.innerHTML = '';
            
            attachedFiles.forEach((file, index) => {
                const attachmentItem = document.createElement('div');
                attachmentItem.className = 'attachment-item';
                
                const icon = getFileIcon(file.type, file.name);
                const fileName = file.name.length > 20 ? file.name.substring(0, 17) + '...' : file.name;
                
                attachmentItem.innerHTML = `
                    ${icon}
                    <span>${fileName}</span>
                    <button class="remove-attachment" onclick="removeAttachment(${index})">
                        <i class="fas fa-times"></i>
                    </button>
                `;
                
                attachmentPreview.appendChild(attachmentItem);
            });
            
            if (attachedFiles.length === 0) {
                attachmentPreview.style.display = 'none';
            }
        }

        // Show notification
        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed;
                top: 85px;
                right: 20px;
                padding: 12px 18px;
                background: ${type === 'error' ? '#f44336' : type === 'warning' ? '#ff9800' : '#4CAF50'};
                color: white;
                border-radius: 10px;
                box-shadow: 0 5px 15px rgba(0,0,0,0.2);
                z-index: 1000;
                animation: slideIn 0.3s ease;
                font-size: 0.9em;
                font-family: 'Quicksand', sans-serif;
            `;
            
            notification.innerHTML = `
                <div style="display: flex; align-items: center; gap: 10px;">
                    <i class="fas fa-${type === 'error' ? 'exclamation-circle' : type === 'warning' ? 'exclamation-triangle' : 'check-circle'}"></i>
                    <span>${message}</span>
                </div>
            `;
            
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.style.animation = 'slideOut 0.3s ease';
                setTimeout(() => notification.remove(), 300);
            }, 3000);
        }

        // Prepare prompt for Gemini
        function preparePrompt(userText, files = []) {
            const subject = subjects[currentSubject];
            let prompt = `Bạn là một giáo viên AI thân thiện, hỗ trợ học sinh THCS trường Nguyễn Tri Phương.
Xưng hô: thầy/cô với học sinh là em.
Chuyên môn: ${subject.name} theo chương trình giáo dục mới THCS Việt Nam.

**QUAN TRỌNG:** Sử dụng markdown để định dạng câu trả lời:
1. Tiêu đề: #, ##, ###, ####
2. In đậm: **văn bản**
3. In nghiêng: *văn bản*
4. Danh sách: - item hoặc 1. item
5. Đường kẻ ngang: ---
6. Code: \`code\` hoặc \`\`\`code block\`\`\`
7. Công thức toán: $công_thức$ (inline) hoặc $$công_thức$$ (display)
   KHÔNG BAO GIỜ tự thêm span hay class. Chỉ dùng $ và $$.

Phong cách: Nhiệt tình, kiên nhẫn, khuyến khích học sinh tự tư duy.\n\n`;

            // Thêm prompt đặc biệt cho môn học
            if (subject.systemPrompt) {
                prompt += `${subject.systemPrompt}\n\n`;
            }

            // Thêm kiến thức từ admin nếu có
            if (subjectKnowledge[currentSubject]) {
                prompt += `KIẾN THỨC BỔ SUNG (từ giáo viên):\n${subjectKnowledge[currentSubject]}\n\n`;
            }

            // Thêm bài tập mẫu nếu có
            if (homeworkData[currentSubject] && homeworkData[currentSubject].length > 0) {
                prompt += `BÀI TẬP THAM KHẢO (có thể sử dụng khi phù hợp):\n`;
                homeworkData[currentSubject].slice(0, 3).forEach((hw, i) => {
                    prompt += `${i+1}. ${hw.question}\n   Gợi ý: ${hw.answer.substring(0, 100)}...\n`;
                });
                prompt += `\n`;
            }

            // Thêm câu hỏi của học sinh
            prompt += `CÂU HỎI CỦA HỌC SINH: ${userText || "Xem file đính kèm và phân tích nội dung."}\n\n`;

            // Thêm thông tin file nếu có
            if (files.length > 0) {
                prompt += `Học sinh đã gửi ${files.length} file đính kèm:\n`;
                files.forEach((file, i) => {
                    prompt += `${i+1}. ${file.name} (${file.type || 'unknown'})\n`;
                });
                prompt += `\nNếu là file bài tập/ảnh bài giải, hãy phân tích và hướng dẫn chi tiết bằng markdown.\n`;
            }

            prompt += `Hãy trả lời một cách hữu ích và khích lệ bằng markdown đầy đủ!`;

            return prompt;
        }

        // Process files for Gemini
        async function processFilesForGemini(files) {
            const processedFiles = [];
            
            for (const file of files) {
                if (file.type.startsWith('image/')) {
                    try {
                        const base64Data = await fileToBase64(file);
                        processedFiles.push({
                            inlineData: {
                                data: base64Data.split(',')[1],
                                mimeType: file.type
                            }
                        });
                    } catch (error) {
                        console.error('Lỗi xử lý ảnh:', error);
                    }
                }
            }
            
            return processedFiles;
        }

        // Get text from non-image files
        async function getTextFromFiles(files) {
            let textInfo = '';
            
            for (const file of files) {
                if (!file.type.startsWith('image/')) {
                    try {
                        if (file.type === 'text/plain' || 
                            file.type.includes('pdf') || 
                            file.type.includes('word') || 
                            file.type.includes('text')) {
                            const text = await file.text();
                            textInfo += `\n\nNội dung file "${file.name}":\n${text.substring(0, 3000)}...`;
                        } else {
                            textInfo += `\n\nFile: ${file.name} (${file.type}) - Không thể đọc nội dung trực tiếp.`;
                        }
                    } catch (error) {
                        textInfo += `\n\nFile: ${file.name} - Lỗi khi đọc nội dung.`;
                    }
                }
            }
            
            return textInfo;
        }

        // Send message
        async function sendMessage() {
            if (isProcessing) return;
            
            const text = messageInput.value.trim();
            
            if (!text && attachedFiles.length === 0) {
                showNotification('Vui lòng nhập tin nhắn hoặc chọn file', 'warning');
                return;
            }
            
            // Add user message to display
            const fileUrls = attachedFiles.map(file => ({
                name: file.name,
                type: file.type,
                url: URL.createObjectURL(file)
            }));
            
            addMessage('user', text, fileUrls);
            
            // Clear input and attachments
            messageInput.value = '';
            const filesToSend = [...attachedFiles];
            attachedFiles = [];
            attachmentPreview.style.display = 'none';
            attachmentPreview.innerHTML = '';
            
            // Disable send button and show loading
            sendButton.disabled = true;
            isProcessing = true;
            sendButton.innerHTML = '<div class="loading-dots"><div class="dot"></div><div class="dot"></div><div class="dot"></div></div>';
            
            try {
                // Check for simple greetings
                const lowerText = text.toLowerCase();
                if (lowerText.includes('chào') || lowerText.includes('hello') || lowerText.includes('hi')) {
                    setTimeout(() => {
                        addMessage('bot', `Chào em! Thầy/cô rất vui được hỗ trợ em học môn **${subjects[currentSubject].name}**. 
                                       \n\nEm có câu hỏi gì về bài học hôm nay không?`);
                        sendButton.disabled = false;
                        isProcessing = false;
                        sendButton.innerHTML = '<i class="fas fa-paper-plane"></i>';
                    }, 500);
                    return;
                }
                
                // Check if Gemini is available
                if (!model) {
                    throw new Error('AI chưa sẵn sàng');
                }
                
                // Prepare content for Gemini
                const prompt = preparePrompt(text, filesToSend);
                
                // Process files
                const fileContents = await processFilesForGemini(filesToSend);
                const fileText = await getTextFromFiles(filesToSend);
                
                // Combine prompt with file text
                const finalPrompt = prompt + fileText;
                
                // Generate response
                let result;
                try {
                    if (fileContents.length > 0) {
                        result = await model.generateContent([finalPrompt, ...fileContents]);
                    } else {
                        result = await model.generateContent(finalPrompt);
                    }
                } catch (apiError) {
                    console.error('Lỗi API Gemini:', apiError);
                    throw new Error('Lỗi kết nối AI');
                }
                
                const response = await result.response;
                const botResponse = response.text();
                
                addMessage('bot', botResponse);
                
            } catch (error) {
                console.error('Lỗi khi gửi tin nhắn:', error);
                
                addMessage('bot', 'Xin lỗi, tạm thời không thể kết nối đến AI. Vui lòng thử lại sau hoặc kiểm tra kết nối mạng.');
                showNotification('Có lỗi xảy ra khi xử lý yêu cầu', 'error');
            }
            
            // Re-enable send button
            sendButton.disabled = false;
            isProcessing = false;
            sendButton.innerHTML = '<i class="fas fa-paper-plane"></i>';
        }

        // Sidebar functions
        function showSidebar() {
            sidebar.classList.add('show');
            sidebarOverlay.classList.add('show');
            sidebarToggleIcon.classList.remove('fa-bars');
            sidebarToggleIcon.classList.add('fa-times');
        }

        function hideSidebar() {
            sidebar.classList.remove('show');
            sidebarOverlay.classList.remove('show');
            sidebarToggleIcon.classList.remove('fa-times');
            sidebarToggleIcon.classList.add('fa-bars');
        }

        // Handle Enter key
        messageInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendMessage();
            }
        });

        // Go to index
        function goToIndex() {
            window.location.href = 'index.html';
        }

        // Logout
        function logout() {
            if (auth) {
                auth.signOut().then(() => {
                    localStorage.removeItem('user');
                    // Clean up listeners
                    cleanupFirestoreListeners();
                    // Xóa tất cả lịch sử chat
                    Object.keys(sessionStorage).forEach(key => {
                        if (key.startsWith('chatHistory_')) {
                            sessionStorage.removeItem(key);
                        }
                    });
                    window.location.href = 'auth.html';
                }).catch(error => {
                    console.error('Lỗi đăng xuất:', error);
                    window.location.href = 'auth.html';
                });
            } else {
                window.location.href = 'auth.html';
            }
        }

        // Clear chat history on page unload
        window.addEventListener('beforeunload', function() {
            cleanupFirestoreListeners();
        });

        // Initialize app
        async function initializeApp() {
            // Add notification styles
            if (!document.querySelector('#notification-styles')) {
                const style = document.createElement('style');
                style.id = 'notification-styles';
                style.textContent = `
                    @keyframes slideIn {
                        from { transform: translateX(100%); opacity: 0; }
                        to { transform: translateX(0); opacity: 1; }
                    }
                    @keyframes slideOut {
                        from { transform: translateX(0); opacity: 1; }
                        to { transform: translateX(100%); opacity: 0; }
                    }
                `;
                document.head.appendChild(style);
            }
            
            initializeUser();
            
            // Chỉ load data khi cần (lazy loading)
            setTimeout(() => {
                loadSubjectKnowledge();
                loadHomeworkData();
            }, 1000);
            
            // Set up subject buttons
            subjectButtons.forEach(button => {
                button.addEventListener('click', () => {
                    selectSubject(button.dataset.subject);
                });
            });
            
            // Set up sidebar toggle
            sidebarToggle.addEventListener('click', function() {
                if (sidebar.classList.contains('show')) {
                    hideSidebar();
                } else {
                    showSidebar();
                }
            });
            
            sidebarOverlay.addEventListener('click', hideSidebar);
            
            // Close sidebar when clicking outside on mobile
            document.addEventListener('click', (e) => {
                if (window.innerWidth <= 768 && 
                    !sidebar.contains(e.target) && 
                    !sidebarToggle.contains(e.target) &&
                    sidebar.classList.contains('show')) {
                    hideSidebar();
                }
            });
            
            // Auto-hide sidebar on desktop when resizing to mobile
            window.addEventListener('resize', function() {
                if (window.innerWidth > 768) {
                    hideSidebar();
                }
            });
            
            // Focus on input
            setTimeout(() => {
                messageInput.focus();
            }, 500);
            
            console.log('✅ Chatbot đã sẵn sàng');
        }

        // Start the app
        document.addEventListener('DOMContentLoaded', initializeApp);
        
        // Make functions available globally
        window.viewImage = viewImage;
        window.removeAttachment = removeAttachment;
        window.logout = logout;
        window.goToIndex = goToIndex;
        window.sendMessage = sendMessage;
    </script>
</body>
</html>
