<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chatbot AI h·ªçc t·∫≠p - THCS Nguy·ªÖn Tri Ph∆∞∆°ng</title>
    
    <!-- Font & Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Quicksand:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- KaTeX for math rendering -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css">
    <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/contrib/auto-render.min.js"></script>
    
    <!-- Markdown parser -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/marked/4.3.0/marked.min.js"></script>
    
    <!-- PDF.js & html2canvas -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    
    <!-- Firebase -->
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
    
    <!-- Mammoth.js for DOCX -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mammoth/1.4.8/mammoth.browser.min.js"></script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Quicksand:wght@400;500;600;700&display=swap');

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Quicksand', sans-serif;
            background: linear-gradient(135deg, #e0f7fa 0%, #bbdefb 100%);
            height: 100%;
            display: flex;
            flex-direction: column;
        }

        html {
            height: 100%;
        }

        .container {
            display: flex;
            flex-direction: column;
            height: 100%;
            width: 100%;
            padding: 0;
        }

        /* Header */
        .header {
            background-color: rgba(255, 255, 255, 0.95);
            box-shadow: 0 2px 15px rgba(0,0,0,0.1);
            backdrop-filter: blur(10px);
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            z-index: 1000;
            padding: 15px 0;
        }

        .nav-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .logo-container {
            display: flex;
            align-items: center;
            gap: 15px;
            cursor: pointer;
        }

        .logo {
            height: 50px;
            border-radius: 8px;
        }

        .school-name {
            font-size: 1.3em;
            font-weight: 700;
            color: #26a69a;
        }

        .web-name {
            font-size: 1.1em;
            font-weight: 600;
            color: #666;
            margin-left: 10px;
        }

        /* User Info Section */
        .user-section {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 8px 15px;
            background: #f8f9fa;
            border-radius: 25px;
            transition: all 0.3s;
        }

        .user-info:hover {
            background: #e9ecef;
        }

        .user-avatar {
            width: 35px;
            height: 35px;
            border-radius: 50%;
            background: linear-gradient(135deg, #26a69a, #4CAF50);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
            font-size: 0.9em;
        }

        .user-details {
            display: flex;
            flex-direction: column;
        }

        .user-name {
            font-weight: 600;
            color: #333;
            font-size: 0.9em;
        }

        .user-email {
            font-size: 0.8em;
            color: #666;
        }

        .logout-btn {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            padding: 10px 20px;
            border-radius: 25px;
            color: #666;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.9em;
            font-weight: 600;
        }

        .logout-btn:hover {
            background: #e9ecef;
            color: #333;
        }

        /* Main Content */
        .main-content {
            display: flex;
            flex: 1;
            overflow: hidden;
            position: relative;
            margin-top: 80px;
            height: calc(100% - 80px);
        }

        /* Sidebar */
        .sidebar {
            width: 250px;
            background: linear-gradient(145deg, #f0f4c3, #e6ee9c);
            border-right: 1px solid #dce775;
            display: flex;
            flex-direction: column;
            padding: 20px;
            overflow-y: auto;
            transition: transform 0.3s ease;
            z-index: 99;
        }

        .sidebar-toggle {
            display: none;
            position: fixed;
            top: 90px;
            left: 20px;
            background: linear-gradient(135deg, #4CAF50, #2E7D32);
            color: white;
            border: none;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            cursor: pointer;
            z-index: 101;
            align-items: center;
            justify-content: center;
            font-size: 1.2em;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
        }

        .sidebar-section {
            margin-bottom: 30px;
        }

        .sidebar-title {
            color: #689f38;
            font-size: 1.1em;
            font-weight: 600;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .subject-button {
            width: 100%;
            padding: 12px 15px;
            margin-bottom: 10px;
            background: linear-gradient(145deg, #c5e1a5, #aed581);
            border: none;
            border-radius: 10px;
            color: #333;
            text-align: left;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 10px;
            font-weight: 500;
        }

        .subject-button:hover {
            background: linear-gradient(145deg, #aed581, #9ccc65);
            transform: translateX(5px);
        }

        .subject-button.active {
            background: linear-gradient(145deg, #8bc34a, #7cb342);
            color: white;
            box-shadow: 0 4px 10px rgba(139, 195, 74, 0.3);
        }

        /* Chat Area */
        .chat-area {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: white;
            width: 100%;
        }

        .chat-header {
            padding: 20px;
            border-bottom: 1px solid #e0e0e0;
            background: linear-gradient(145deg, #ffffff, #f5f5f5);
        }

        .chat-header h2 {
            color: #333;
            font-size: 1.4em;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .chat-header-info {
            color: #666;
            font-size: 0.9em;
            margin-top: 5px;
        }

        .messages-container {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            background: linear-gradient(145deg, #ffffff, #f5f5f5);
        }

        .message {
            margin-bottom: 20px;
            max-width: 85%;
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .user-message {
            margin-left: auto;
        }

        .bot-message {
            margin-right: auto;
        }

        .message-content {
            padding: 15px 20px;
            border-radius: 20px;
            position: relative;
            word-wrap: break-word;
            line-height: 1.6;
            overflow-x: auto;
        }

        .user-message .message-content {
            background: linear-gradient(145deg, #007bff, #0056b3);
            color: white;
            border-bottom-right-radius: 5px;
        }

        .bot-message .message-content {
            background: linear-gradient(145deg, #e3f2fd, #bbdefb);
            color: #212121;
            border-bottom-left-radius: 5px;
            overflow-wrap: break-word;
        }

        /* Markdown Styling */
        .message-content h1,
        .message-content h2,
        .message-content h3,
        .message-content h4 {
            margin: 16px 0 10px 0;
            color: #2c3e50;
            font-weight: 600;
            font-family: 'Quicksand', sans-serif;
        }

        .message-content h1 { font-size: 1.4em; }
        .message-content h2 { font-size: 1.3em; }
        .message-content h3 { font-size: 1.2em; }
        .message-content h4 { font-size: 1.1em; }

        .message-content strong {
            font-weight: 700;
        }

        .message-content em {
            font-style: italic;
        }

        .message-content code {
            background: rgba(0, 0, 0, 0.05);
            padding: 2px 6px;
            border-radius: 4px;
            font-family: 'Courier New', Courier, monospace;
            font-size: 0.95em;
        }

        .message-content pre {
            background: #2d2d2d;
            color: #f8f8f2;
            padding: 12px;
            border-radius: 8px;
            overflow-x: auto;
            margin: 12px 0;
            font-family: 'Courier New', Courier, monospace;
            font-size: 0.9em;
        }

        .message-content pre code {
            background: transparent;
            padding: 0;
            color: inherit;
            font-size: inherit;
        }

        .message-content ul,
        .message-content ol {
            margin: 10px 0 10px 24px;
        }

        .message-content li {
            margin-bottom: 6px;
        }

        .message-content blockquote {
            border-left: 4px solid #4CAF50;
            padding-left: 16px;
            margin: 12px 0;
            color: #555;
            font-style: italic;
        }

        .message-content hr {
            border: none;
            border-top: 2px solid #e0e0e0;
            margin: 16px 0;
        }

        .message-content table {
            border-collapse: collapse;
            margin: 12px 0;
            width: 100%;
            font-size: 0.95em;
        }

        .message-content th,
        .message-content td {
            border: 1px solid #ddd;
            padding: 10px;
            text-align: left;
        }

        .message-content th {
            background-color: #f2f2f2;
            font-weight: 600;
        }

        /* KaTeX Styling */
        .message-content .katex,
        .message-content .katex-display {
            font-family: 'Quicksand', sans-serif !important;
        }

        .katex {
            font-family: 'Quicksand', sans-serif !important;
        }

        .message-time {
            font-size: 0.8em;
            color: #999;
            margin-top: 5px;
            text-align: right;
        }

        .user-message .message-time {
            text-align: right;
        }

        .bot-message .message-time {
            text-align: left;
        }

        .file-attachment {
            margin-top: 10px;
            padding: 10px;
            background: rgba(255, 255, 255, 0.9);
            border-radius: 10px;
            border: 1px solid #dee2e6;
        }

        .file-attachment a {
            display: flex;
            align-items: center;
            gap: 10px;
            color: #007bff;
            text-decoration: none;
            font-weight: 500;
        }

        .file-attachment a:hover {
            text-decoration: underline;
        }

        .file-preview {
            max-width: 200px;
            max-height: 200px;
            border-radius: 8px;
            margin-top: 10px;
            border: 1px solid #dee2e6;
        }

        /* PDF Preview */
        .pdf-preview {
            background: linear-gradient(145deg, #f8f9fa, #e9ecef);
            border-left: 3px solid #e63946;
            padding: 8px 12px;
            margin-top: 8px;
            border-radius: 4px;
            font-size: 0.85em;
        }

        .pdf-converting {
            background: #fff3cd;
            border-left: 3px solid #ffc107;
            padding: 8px 12px;
            margin-top: 8px;
            border-radius: 4px;
            font-size: 0.85em;
            color: #856404;
        }

        /* File Preview Text */
        .file-preview-text {
            max-height: 200px;
            overflow-y: auto;
            background: #f8f9fa;
            padding: 10px;
            border-radius: 5px;
            border: 1px solid #dee2e6;
            margin-top: 5px;
            font-size: 0.85em;
            white-space: pre-wrap;
            word-wrap: break-word;
        }

        /* File Type Hint */
        .file-type-hint {
            background: #d1ecf1;
            border-left: 4px solid #0dcaf0;
            padding: 10px 15px;
            margin: 10px 0;
            border-radius: 5px;
            font-size: 0.9em;
            color: #055160;
        }

        /* Input Area */
        .input-area {
            padding: 20px;
            border-top: 1px solid #e0e0e0;
            background: white;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .attachment-preview {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            padding: 10px;
            background: #f8f9fa;
            border-bottom: 1px solid #e9ecef;
            display: none;
        }

        .attachment-item {
            display: flex;
            flex-direction: column;
            gap: 8px;
            background: white;
            padding: 10px;
            border-radius: 10px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            font-size: 0.9em;
            width: 100%;
            max-width: 300px;
        }

        .attachment-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 8px;
        }

        .remove-attachment {
            background: none;
            border: none;
            color: #dc3545;
            cursor: pointer;
            font-size: 1.2em;
            padding: 0 5px;
        }

        .file-input {
            display: none;
        }

        .file-button {
            background: #6c757d;
            color: white;
            border: none;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2em;
            transition: all 0.3s;
        }

        .file-button:hover {
            background: #5a6268;
            transform: translateY(-2px);
        }

        .message-input {
            flex: 1;
            padding: 15px 20px;
            border: 2px solid #c5e1a5;
            border-radius: 25px;
            font-size: 1em;
            transition: all 0.3s;
            font-family: 'Quicksand', sans-serif;
        }

        .message-input:focus {
            border-color: #8bc34a;
            outline: none;
            box-shadow: 0 0 0 3px rgba(139, 195, 74, 0.2);
        }

        .send-button {
            background: linear-gradient(145deg, #4CAF50, #2E7D32);
            color: white;
            border: none;
            width: 55px;
            height: 55px;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.3em;
            transition: all 0.3s;
        }

        .send-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(76, 175, 80, 0.3);
        }

        .send-button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .loading-dots {
            display: flex;
            gap: 5px;
        }

        .dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #666;
            animation: bounce 1.4s infinite ease-in-out both;
        }

        .dot:nth-child(1) { animation-delay: -0.32s; }
        .dot:nth-child(2) { animation-delay: -0.16s; }

        @keyframes bounce {
            0%, 80%, 100% { transform: scale(0); }
            40% { transform: scale(1); }
        }

        /* Animation cho qu√° tr√¨nh x·ª≠ l√Ω */
        @keyframes processing {
            0% { opacity: 0.6; }
            50% { opacity: 1; }
            100% { opacity: 0.6; }
        }

        .processing {
            animation: processing 1.5s infinite;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .container {
                height: 100%;
            }
            
            .main-content {
                flex-direction: row;
                margin-top: 80px;
                height: calc(100% - 80px);
            }
            
            .sidebar-toggle {
                display: flex;
            }
            
            .sidebar {
                position: fixed;
                left: 0;
                top: 80px;
                height: calc(100% - 80px);
                z-index: 100;
                transform: translateX(-100%);
                box-shadow: 2px 0 10px rgba(0,0,0,0.1);
            }
            
            .sidebar.show {
                transform: translateX(0);
            }
            
            .sidebar-overlay {
                display: none;
                position: fixed;
                top: 80px;
                left: 0;
                width: 100%;
                height: calc(100% - 80px);
                background: rgba(0,0,0,0.5);
                z-index: 99;
            }
            
            .sidebar-overlay.show {
                display: block;
            }
            
            .chat-area {
                width: 100%;
            }
            
            .sidebar-section {
                margin-bottom: 15px;
            }
            
            .subject-button {
                padding: 10px;
                font-size: 0.9em;
            }
            
            .chat-header {
                padding: 15px;
            }
            
            .chat-header h2 {
                font-size: 1.2em;
            }
            
            .messages-container {
                padding: 15px;
            }
            
            .message {
                max-width: 90%;
            }
            
            .input-area {
                padding: 15px;
            }
            
            .file-button, .send-button {
                width: 45px;
                height: 45px;
            }
            
            .web-name {
                display: none;
            }
            
            .user-details {
                display: none;
            }
            
            .logout-btn span {
                display: none;
            }
            
            .nav-container {
                padding: 0 15px;
            }
            
            .logo {
                height: 40px;
            }
            
            .school-name {
                font-size: 1em;
            }
        }

        @media (max-width: 480px) {
            .nav-container {
                padding: 0 10px;
            }
            
            .logo {
                height: 35px;
            }
            
            .school-name {
                font-size: 0.9em;
            }
            
            .sidebar-title {
                font-size: 1em;
            }
            
            .subject-button {
                font-size: 0.85em;
            }
            
            .main-content {
                margin-top: 75px;
                height: calc(100% - 75px);
            }
            
            .sidebar {
                top: 75px;
                height: calc(100% - 75px);
            }
            
            .sidebar-overlay {
                top: 75px;
                height: calc(100% - 75px);
            }
            
            .sidebar-toggle {
                top: 85px;
            }
        }
    </style>
</head>
<body>
    <!-- Header -->
    <header class="header">
        <div class="nav-container">
            <!-- Logo v√† t√™n web -->
            <div class="logo-container" onclick="goToIndex()">
                <img src="./·ª®ng d·ª•ng v√† tr·ª£ l√Ω ·∫£o tr√≠ tu·ªá nh√¢n t·∫°o h·ªçc t·∫≠p trong tr∆∞·ªùng THCS_files/20240918-01.png" alt="Logo tr∆∞·ªùng THCS Nguy·ªÖn Tri Ph∆∞∆°ng" class="logo">
                <div>
                    <div class="school-name">THCS Nguy·ªÖn Tri Ph∆∞∆°ng</div>
                    <div class="web-name">H·ªá th·ªëng h·ªçc t·∫≠p AI</div>
                </div>
            </div>
            
            <!-- Th√¥ng tin ng∆∞·ªùi d√πng -->
            <div class="user-section" id="userSection">
                <div class="user-info">
                    <div class="user-avatar" id="userAvatar">N</div>
                    <div class="user-details">
                        <div class="user-name" id="userName">Ng∆∞·ªùi d√πng</div>
                        <div class="user-email" id="userEmail">hmtpum002@gmail.com</div>
                    </div>
                </div>
                <button onclick="logout()" class="logout-btn">
                    <i class="fas fa-sign-out-alt"></i>
                    <span>ƒêƒÉng xu·∫•t</span>
                </button>
            </div>
        </div>
    </header>
    
    <!-- Main Content -->
    <div class="main-content">
        <!-- Sidebar Toggle Button (mobile only) -->
        <button class="sidebar-toggle" id="sidebarToggle">
            <i class="fas fa-bars" id="sidebarToggleIcon"></i>
        </button>
        
        <!-- Sidebar Overlay (mobile only) -->
        <div class="sidebar-overlay" id="sidebarOverlay"></div>
        
        <!-- Sidebar -->
        <div class="sidebar" id="sidebar">
            <div class="sidebar-section">
                <div class="sidebar-title">
                    <i class="fas fa-book-open"></i> M√¥n h·ªçc
                </div>
                <button class="subject-button active" data-subject="toan-dai">
                    <i class="fas fa-calculator"></i> To√°n ƒê·∫°i S·ªë
                </button>
                <button class="subject-button" data-subject="toan-hinh">
                    <i class="fas fa-shapes"></i> To√°n H√¨nh H·ªçc
                </button>
                <button class="subject-button" data-subject="ngu-van">
                    <i class="fas fa-book"></i> Ng·ªØ VƒÉn
                </button>
            </div>
            
            <div class="sidebar-section">
                <div class="sidebar-title">
                    <i class="fas fa-flask"></i> Khoa h·ªçc
                </div>
                <button class="subject-button" data-subject="khtn">
                    <i class="fas fa-atom"></i> KHTN
                </button>
                <button class="subject-button" data-subject="lich-su-dia-ly">
                    <i class="fas fa-map"></i> L·ªãch S·ª≠ & ƒê·ªãa L√Ω
                </button>
                <button class="subject-button" data-subject="cong-nghe">
                    <i class="fas fa-robot"></i> C√¥ng Ngh·ªá
                </button>
            </div>
            
            <div class="sidebar-section">
                <div class="sidebar-title">
                    <i class="fas fa-language"></i> Ng√¥n ng·ªØ
                </div>
                <button class="subject-button" data-subject="anh-van">
                    <i class="fas fa-globe"></i> Anh VƒÉn
                </button>
                <button class="subject-button" data-subject="tin-hoc">
                    <i class="fas fa-laptop-code"></i> Tin H·ªçc
                </button>
            </div>
            
            <div class="sidebar-section">
                <div class="sidebar-title">
                    <i class="fas fa-users"></i> Kh√°c
                </div>
                <button class="subject-button" data-subject="gdcd">
                    <i class="fas fa-balance-scale"></i> GDCD
                </button>
                <button class="subject-button" data-subject="hdtn-hn">
                    <i class="fas fa-hands-helping"></i> HƒêTN - HN
                </button>
                <button class="subject-button" data-subject="stem">
                    <i class="fas fa-cogs"></i> STEM
                </button>
            </div>
        </div>
        
        <!-- Chat Area -->
        <div class="chat-area">
            <div class="chat-header">
                <h2><i class="fas fa-robot"></i> Chatbot AI h·ªçc t·∫≠p</h2>
                <div class="chat-header-info" id="subjectInfo">
                    Ch√†o em! Th·∫ßy/c√¥ s·∫µn s√†ng h·ªó tr·ª£ em h·ªçc m√¥n <strong>To√°n ƒê·∫°i S·ªë</strong>. 
                    Em c√≥ th·ªÉ h·ªèi b√†i, g·ª≠i file ho·∫∑c y√™u c·∫ßu b√†i t·∫≠p.
                </div>
            </div>
            
            <div class="messages-container" id="messagesContainer">
                <!-- Messages will be loaded here -->
                <div class="message bot-message">
                    <div class="message-content">Ch√†o em! Th·∫ßy/c√¥ l√† tr·ª£ l√Ω AI h·ªçc t·∫≠p c·ªßa tr∆∞·ªùng THCS Nguy·ªÖn Tri Ph∆∞∆°ng.<br>Em c√≥ th·ªÉ h·ªèi b·∫•t c·ª© ƒëi·ªÅu g√¨ v·ªÅ m√¥n <strong>To√°n ƒê·∫°i S·ªë</strong>,<br>g·ª≠i file b√†i t·∫≠p, ho·∫∑c y√™u c·∫ßu gi·∫£i th√≠ch chi ti·∫øt.</div>
                    <div class="message-time" id="welcomeTime"></div>
                </div>
            </div>
            
            <!-- Attachment Preview -->
            <div class="attachment-preview" id="attachmentPreview"></div>
            
            <!-- Input Area -->
            <div class="input-area">
                <input type="file" id="fileInput" class="file-input" multiple accept=".jpg,.jpeg,.png,.gif,.pdf,.doc,.docx,.txt,.ppt,.pptx">
                <button class="file-button" onclick="document.getElementById('fileInput').click()">
                    <i class="fas fa-paperclip"></i>
                </button>
                
                <input type="text" class="message-input" id="messageInput" placeholder="H·ªèi th·∫ßy/c√¥ ƒëi·ªÅu g√¨ ƒë√≥..." autocomplete="off">
                
                <button class="send-button" id="sendButton" onclick="sendMessage()">
                    <i class="fas fa-paper-plane"></i>
                </button>
            </div>
        </div>
    </div>

    <!-- Import Google Generative AI -->
    <script type="importmap">
        {
            "imports": {
                "@google/generative-ai": "https://esm.run/@google/generative-ai"
            }
        }
    </script>

    <script type="module">
        // Initialize modules
        import { GoogleGenerativeAI } from "@google/generative-ai";

        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyA7eSuNHa_QXFgC-KsCeCLY5MdL90_FZsQ",
            authDomain: "thuvienhoctap-b24ae.firebaseapp.com",
            projectId: "thuvienhoctap-b24ae",
            storageBucket: "thuvienhoctap-b24ae.appspot.com",
            messagingSenderId: "25688122219",
            appId: "1:25688122219:web:6ff91267b41968a23e622e"
        };

        // Initialize Firebase
        let firestoreInitialized = false;
        let auth, db;
        
        try {
            if (!firebase.apps.length) {
                firebase.initializeApp(firebaseConfig);
            }
            
            auth = firebase.auth();
            db = firebase.firestore();
            firestoreInitialized = true;
            
            db.settings({
                cacheSizeBytes: firebase.firestore.CACHE_SIZE_UNLIMITED
            });
            
            db.enablePersistence()
                .catch((err) => {
                    console.warn('Kh√¥ng th·ªÉ b·∫≠t persistence:', err.code);
                });
                
        } catch (error) {
            console.warn('Kh√¥ng th·ªÉ kh·ªüi t·∫°o Firebase, ch·∫ø ƒë·ªô offline:', error);
            firestoreInitialized = false;
        }

        // Initialize Gemini AI
        const GEMINI_API_KEY = "I2KvIpFfUmO_NoGghLU9ZXp-_sDB4xftCySazIA".split("").reverse().join("");
        
        let genAI, model;
        try {
            genAI = new GoogleGenerativeAI(GEMINI_API_KEY);
            model = genAI.getGenerativeModel({ 
                model: "gemini-2.5-flash",
                generationConfig: {
                    temperature: 0.7,
                    topP: 0.8,
                    topK: 40,
                    maxOutputTokens: 2048,
                }
            });
            console.log('‚úÖ Gemini AI ƒë√£ ƒë∆∞·ª£c kh·ªüi t·∫°o');
        } catch (error) {
            console.error("L·ªói kh·ªüi t·∫°o Gemini:", error);
            model = null;
        }

        // DOM Elements
        const userSection = document.getElementById('userSection');
        const userAvatar = document.getElementById('userAvatar');
        const userName = document.getElementById('userName');
        const userEmail = document.getElementById('userEmail');
        const subjectInfo = document.getElementById('subjectInfo');
        const messagesContainer = document.getElementById('messagesContainer');
        const messageInput = document.getElementById('messageInput');
        const sendButton = document.getElementById('sendButton');
        const fileInput = document.getElementById('fileInput');
        const attachmentPreview = document.getElementById('attachmentPreview');
        const subjectButtons = document.querySelectorAll('.subject-button');
        const sidebar = document.getElementById('sidebar');
        const sidebarToggle = document.getElementById('sidebarToggle');
        const sidebarToggleIcon = document.getElementById('sidebarToggleIcon');
        const sidebarOverlay = document.getElementById('sidebarOverlay');
        const welcomeTime = document.getElementById('welcomeTime');

        // Set welcome message time
        if (welcomeTime) {
            const now = new Date();
            welcomeTime.textContent = now.toLocaleTimeString('vi-VN', { 
                hour: '2-digit', 
                minute: '2-digit' 
            });
        }

        // App State
        let currentUser = null;
        let currentSubject = 'toan-dai';
        let attachedFiles = [];
        let subjectKnowledge = {};
        let homeworkData = {};
        let chatHistory = [];
        let isProcessing = false;
        let firestoreListeners = [];

        // Subject definitions
        const subjects = {
            'toan-dai': { 
                name: 'To√°n ƒê·∫°i S·ªë', 
                icon: 'calculator',
                systemPrompt: "B·∫°n l√† gi√°o vi√™n To√°n ƒê·∫°i S·ªë THCS. H∆∞·ªõng d·∫´n chi ti·∫øt, gi·∫£i th√≠ch t·ª´ng b∆∞·ªõc. S·ª≠ d·ª•ng LaTeX cho c√¥ng th·ª©c to√°n: $c√¥ng_th·ª©c$ cho inline v√† $$c√¥ng_th·ª©c$$ cho display. Kh√¥ng t·ª± b·ªçc span."
            },
            'toan-hinh': { 
                name: 'To√°n H√¨nh H·ªçc', 
                icon: 'shapes',
                systemPrompt: "B·∫°n l√† gi√°o vi√™n To√°n H√¨nh H·ªçc THCS. M√¥ t·∫£ h√¨nh v·∫Ω chi ti·∫øt b·∫±ng l·ªùi. Gi·∫£i th√≠ch c√°c ƒë·ªãnh l√Ω, c√¥ng th·ª©c. S·ª≠ d·ª•ng LaTeX cho c√¥ng th·ª©c to√°n."
            },
            'ngu-van': { 
                name: 'Ng·ªØ VƒÉn', 
                icon: 'book',
                systemPrompt: "B·∫°n l√† gi√°o vi√™n Ng·ªØ VƒÉn THCS. Ph√¢n t√≠ch t√°c ph·∫©m, h∆∞·ªõng d·∫´n vi·∫øt vƒÉn. Ch√∫ tr·ªçng c·∫£m th·ª• vƒÉn h·ªçc."
            },
            'khtn': { 
                name: 'Khoa H·ªçc T·ª± Nhi√™n', 
                icon: 'atom',
                systemPrompt: "B·∫°n l√† gi√°o vi√™n KHTN THCS. Gi·∫£i th√≠ch hi·ªán t∆∞·ª£ng khoa h·ªçc. S·ª≠ d·ª•ng LaTeX cho c√¥ng th·ª©c h√≥a h·ªçc, v·∫≠t l√Ω."
            },
            'lich-su-dia-ly': { 
                name: 'L·ªãch S·ª≠ & ƒê·ªãa L√Ω', 
                icon: 'map',
                systemPrompt: "B·∫°n l√† gi√°o vi√™n L·ªãch S·ª≠ & ƒê·ªãa L√Ω THCS. Cung c·∫•p th√¥ng tin ch√≠nh x√°c v·ªÅ s·ª± ki·ªán l·ªãch s·ª≠ v√† ƒë·ªãa l√Ω Vi·ªát Nam."
            },
            'cong-nghe': { 
                name: 'C√¥ng Ngh·ªá', 
                icon: 'robot',
                systemPrompt: "B·∫°n l√† gi√°o vi√™n C√¥ng Ngh·ªá THCS. H∆∞·ªõng d·∫´n th·ª±c h√†nh, an to√†n lao ƒë·ªông. Gi·∫£i th√≠ch nguy√™n l√Ω k·ªπ thu·∫≠t."
            },
            'anh-van': { 
                name: 'Anh VƒÉn', 
                icon: 'globe',
                systemPrompt: "B·∫°n l√† gi√°o vi√™n ti·∫øng Anh THCS. S·ª≠ d·ª•ng c·∫£ ti·∫øng Anh v√† ti·∫øng Vi·ªát. Gi·∫£i th√≠ch ng·ªØ ph√°p, t·ª´ v·ª±ng."
            },
            'tin-hoc': { 
                name: 'Tin H·ªçc', 
                icon: 'laptop-code',
                systemPrompt: "B·∫°n l√† gi√°o vi√™n Tin H·ªçc THCS. H∆∞·ªõng d·∫´n l·∫≠p tr√¨nh, s·ª≠ d·ª•ng ph·∫ßn m·ªÅm. Gi·∫£i th√≠ch thu·∫≠t to√°n ƒë∆°n gi·∫£n."
            },
            'gdcd': { 
                name: 'Gi√°o D·ª•c C√¥ng D√¢n', 
                icon: 'balance-scale',
                systemPrompt: "B·∫°n l√† gi√°o vi√™n GDCD THCS. Gi·∫£i th√≠ch c√°c quy·ªÅn v√† nghƒ©a v·ª• c√¥ng d√¢n. H∆∞·ªõng d·∫´n ·ª©ng x·ª≠ ƒë·∫°o ƒë·ª©c."
            },
            'hdtn-hn': { 
                name: 'Ho·∫°t ƒê·ªông Tr·∫£i Nghi·ªám - H∆∞·ªõng Nghi·ªáp', 
                icon: 'hands-helping',
                systemPrompt: "B·∫°n l√† gi√°o vi√™n HƒêTN-HN THCS. H∆∞·ªõng d·∫´n k·ªπ nƒÉng s·ªëng, ƒë·ªãnh h∆∞·ªõng ngh·ªÅ nghi·ªáp."
            },
            'stem': { 
                name: 'STEM', 
                icon: 'cogs',
                systemPrompt: "B·∫°n l√† gi√°o vi√™n STEM THCS. T√≠ch h·ª£p Khoa h·ªçc, C√¥ng ngh·ªá, K·ªπ thu·∫≠t v√† To√°n h·ªçc. S·ª≠ d·ª•ng LaTeX cho c√¥ng th·ª©c."
            }
        };

        // Configure marked for markdown parsing
        marked.setOptions({
            breaks: true,
            gfm: true,
            headerIds: false
        });

        // ========== CORE FUNCTIONS ==========

        // Initialize user
        function initializeUser() {
            const userData = JSON.parse(localStorage.getItem('user') || '{}');
            
            if (userData.uid && !userData.isGuest) {
                currentUser = userData;
                const displayName = userData.displayName || 'Ng∆∞·ªùi d√πng';
                const email = userData.email || '';
                const firstLetter = displayName.charAt(0).toUpperCase();
                
                userAvatar.textContent = firstLetter;
                userName.textContent = displayName;
                userEmail.textContent = email;
                
                userSection.innerHTML = `
                    <div class="user-info">
                        <div class="user-avatar">${firstLetter}</div>
                        <div class="user-details">
                            <div class="user-name">${displayName}</div>
                            ${email ? `<div class="user-email">${email}</div>` : ''}
                        </div>
                    </div>
                    <button onclick="logout()" class="logout-btn">
                        <i class="fas fa-sign-out-alt"></i>
                        <span>ƒêƒÉng xu·∫•t</span>
                    </button>
                `;
            } else {
                currentUser = {
                    uid: userData.uid || 'guest_' + Date.now(),
                    displayName: 'Kh√°ch',
                    isGuest: true
                };
                userSection.innerHTML = `
                    <a href="auth.html" class="logout-btn" style="text-decoration: none;">
                        <i class="fas fa-sign-in-alt"></i>
                        <span>ƒêƒÉng nh·∫≠p</span>
                    </a>
                `;
            }
            
            const savedHistory = sessionStorage.getItem(`chatHistory_${currentUser.uid}_${currentSubject}`);
            if (savedHistory) {
                try {
                    chatHistory = JSON.parse(savedHistory);
                    displayChatHistory();
                } catch (error) {
                    console.error('L·ªói khi t·∫£i l·ªãch s·ª≠ chat:', error);
                    chatHistory = [];
                }
            }
        }

        // File to base64
        function fileToBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = () => resolve(reader.result);
                reader.onerror = error => reject(error);
            });
        }

        // H√†m chuy·ªÉn PDF th√†nh ·∫£nh
        async function pdfToImages(file) {
            try {
                console.log('B·∫Øt ƒë·∫ßu chuy·ªÉn PDF th√†nh ·∫£nh:', file.name);
                
                const fileUrl = URL.createObjectURL(file);
                const loadingTask = pdfjsLib.getDocument(fileUrl);
                const pdf = await loadingTask.promise;
                
                console.log(`PDF c√≥ ${pdf.numPages} trang`);
                
                const images = [];
                const maxPages = Math.min(pdf.numPages, 3);
                
                for (let pageNum = 1; pageNum <= maxPages; pageNum++) {
                    console.log(`ƒêang x·ª≠ l√Ω trang ${pageNum}/${maxPages}`);
                    
                    const page = await pdf.getPage(pageNum);
                    const scale = 1.5;
                    const viewport = page.getViewport({ scale });
                    
                    const canvas = document.createElement('canvas');
                    const context = canvas.getContext('2d');
                    
                    canvas.height = viewport.height;
                    canvas.width = viewport.width;
                    
                    const renderContext = {
                        canvasContext: context,
                        viewport: viewport
                    };
                    
                    await page.render(renderContext).promise;
                    
                    const imageBlob = await new Promise(resolve => {
                        canvas.toBlob(resolve, 'image/jpeg', 0.7);
                    });
                    
                    const imageFile = new File(
                        [imageBlob], 
                        `${file.name}_page_${pageNum}.jpg`, 
                        { type: 'image/jpeg' }
                    );
                    
                    images.push(imageFile);
                }
                
                URL.revokeObjectURL(fileUrl);
                console.log(`ƒê√£ chuy·ªÉn ${images.length} trang PDF th√†nh ·∫£nh`);
                return images;
                
            } catch (error) {
                console.error('L·ªói chuy·ªÉn PDF th√†nh ·∫£nh:', error);
                throw new Error(`Kh√¥ng th·ªÉ chuy·ªÉn PDF th√†nh ·∫£nh: ${error.message}`);
            }
        }

        // H√†m ƒë·ªçc DOC/DOCX
        async function readDocxFile(file) {
            try {
                const arrayBuffer = await file.arrayBuffer();
                const result = await mammoth.extractRawText({ arrayBuffer: arrayBuffer });
                return result.value;
            } catch (error) {
                console.error('L·ªói ƒë·ªçc DOCX:', error);
                return `[Kh√¥ng th·ªÉ ƒë·ªçc n·ªôi dung DOCX: ${file.name}]`;
            }
        }

        // H√†m ƒë·ªçc file vƒÉn b·∫£n
        async function readTextFile(file) {
            try {
                if (file.type === 'text/plain' || file.name.endsWith('.txt')) {
                    return await file.text();
                } else if (file.name.endsWith('.doc') || file.name.endsWith('.docx') || 
                          file.type.includes('word') || file.type.includes('document')) {
                    return await readDocxFile(file);
                } else if (file.name.endsWith('.ppt') || file.name.endsWith('.pptx')) {
                    return `[File PowerPoint: ${file.name} - Vui l√≤ng chuy·ªÉn sang PDF ho·∫∑c ·∫£nh ƒë·ªÉ ph√¢n t√≠ch]`;
                } else {
                    return `[ƒê·ªãnh d·∫°ng kh√¥ng h·ªó tr·ª£ ƒë·ªçc: ${file.name}]`;
                }
            } catch (error) {
                console.error('L·ªói ƒë·ªçc file:', error);
                return `[L·ªói khi ƒë·ªçc file ${file.name}]`;
            }
        }

        // X·ª≠ l√Ω file cho AI
        async function processFilesForAI(files) {
            const processedFiles = [];
            const textContents = [];
            
            for (const file of files) {
                if (file.type.startsWith('image/')) {
                    try {
                        const base64Data = await fileToBase64(file);
                        processedFiles.push({
                            inlineData: {
                                data: base64Data.split(',')[1],
                                mimeType: file.type
                            }
                        });
                    } catch (error) {
                        console.error('L·ªói x·ª≠ l√Ω ·∫£nh:', error);
                    }
                    
                } else if (file.type.includes('pdf') || file.name.endsWith('.pdf')) {
                    try {
                        showNotification(`ƒêang chuy·ªÉn PDF "${file.name}" th√†nh ·∫£nh...`, 'info');
                        
                        const pdfImages = await pdfToImages(file);
                        
                        for (const imageFile of pdfImages) {
                            try {
                                const base64Data = await fileToBase64(imageFile);
                                processedFiles.push({
                                    inlineData: {
                                        data: base64Data.split(',')[1],
                                        mimeType: 'image/jpeg'
                                    }
                                });
                            } catch (error) {
                                console.error('L·ªói x·ª≠ l√Ω ·∫£nh PDF:', error);
                            }
                        }
                        
                        showNotification(`ƒê√£ chuy·ªÉn ${pdfImages.length} trang PDF th√†nh ·∫£nh`, 'success');
                        
                    } catch (error) {
                        console.error('L·ªói x·ª≠ l√Ω PDF:', error);
                        textContents.push(`[PDF: ${file.name} - Kh√¥ng th·ªÉ chuy·ªÉn th√†nh ·∫£nh]`);
                    }
                    
                } else {
                    try {
                        const text = await readTextFile(file);
                        textContents.push(`\n\n--- FILE: ${file.name} ---\n${text.substring(0, 3000)}`);
                    } catch (error) {
                        console.error('L·ªói ƒë·ªçc file vƒÉn b·∫£n:', error);
                        textContents.push(`\n\n--- FILE: ${file.name} ---\n[Kh√¥ng th·ªÉ ƒë·ªçc n·ªôi dung]`);
                    }
                }
            }
            
            return {
                images: processedFiles,
                text: textContents.join('\n')
            };
        }

        // Chu·∫©n b·ªã prompt
        function preparePrompt(userText, hasImages = false, hasPDF = false) {
            const subject = subjects[currentSubject];
            
            let prompt = `B·∫°n l√† gi√°o vi√™n AI c·ªßa tr∆∞·ªùng THCS Nguy·ªÖn Tri Ph∆∞∆°ng.
X∆∞ng h√¥: th·∫ßy/c√¥ v·ªõi h·ªçc sinh l√† "em".
Chuy√™n m√¥n: ${subject.name} - Ch∆∞∆°ng tr√¨nh gi√°o d·ª•c ph·ªï th√¥ng m·ªõi.

**H∆Ø·ªöNG D·∫™N PH√ÇN T√çCH:**
1. S·ª≠ d·ª•ng markdown ƒë·ªÉ ƒë·ªãnh d·∫°ng
2. C√¥ng th·ª©c to√°n: $...$ ho·∫∑c $$...$$
3. KH√îNG d√πng th·∫ª HTML
4. Ph√¢n t√≠ch t·ª´ng b∆∞·ªõc chi ti·∫øt

Phong c√°ch: Nhi·ªát t√¨nh, ki√™n nh·∫´n, khuy·∫øn kh√≠ch h·ªçc sinh t·ª± t∆∞ duy.\n\n`;

            if (subject.systemPrompt) {
                prompt += `${subject.systemPrompt}\n\n`;
            }

            if (hasImages || hasPDF) {
                prompt += `**H·ªåC SINH ƒê√É G·ª¨I B√ÄI T·∫¨P D∆Ø·ªöI D·∫†NG H√åNH ·∫¢NH/PDF:**\n`;
                prompt += `H√£y ph√¢n t√≠ch n·ªôi dung trong ·∫£nh/PDF theo c√°c b∆∞·ªõc:\n`;
                prompt += `1. **M√î T·∫¢ N·ªòI DUNG**: T√≥m t·∫Øt ƒë·ªÅ b√†i, c√¢u h·ªèi trong ·∫£nh\n`;
                prompt += `2. **PH√ÇN LO·∫†I**: X√°c ƒë·ªãnh d·∫°ng b√†i t·∫≠p\n`;
                prompt += `3. **H∆Ø·ªöNG D·∫™N GI·∫¢I**: T·ª´ng b∆∞·ªõc chi ti·∫øt\n`;
                prompt += `4. **GI·∫¢I TH√çCH**: C√°c kh√°i ni·ªám, ƒë·ªãnh l√Ω li√™n quan\n`;
                prompt += `5. **B√ÄI T·∫¨P T∆Ø∆†NG T·ª∞**: ƒê·ªÅ xu·∫•t b√†i t·∫≠p luy·ªán t·∫≠p\n`;
                prompt += `6. **L∆ØU √ù**: Sai l·∫ßm th∆∞·ªùng g·∫∑p\n\n`;
                
                if (currentSubject.includes('toan')) {
                    prompt += `**ƒê·ªêI V·ªöI TO√ÅN**:\n`;
                    prompt += `- Nh·∫≠n d·∫°ng c√¥ng th·ª©c to√°n trong ·∫£nh\n`;
                    prompt += `- Vi·∫øt l·∫°i c√¥ng th·ª©c b·∫±ng LaTeX\n`;
                    prompt += `- Gi·∫£i th√≠ch t·ª´ng b∆∞·ªõc bi·∫øn ƒë·ªïi\n`;
                    prompt += `- Ki·ªÉm tra k·∫øt qu·∫£ n·∫øu c√≥ ƒë√°p √°n\n\n`;
                }
            }

            prompt += `C√ÇU H·ªéI/ƒê·ªÄ B√ÄI: ${userText || "Ph√¢n t√≠ch n·ªôi dung trong file/·∫£nh ƒë√≠nh k√®m"}\n\n`;

            return prompt;
        }

        // Send message
        async function sendMessage() {
            if (isProcessing) return;
            
            const text = messageInput.value.trim();
            
            if (!text && attachedFiles.length === 0) {
                showNotification('Vui l√≤ng nh·∫≠p tin nh·∫Øn ho·∫∑c ch·ªçn file', 'warning');
                return;
            }
            
            const fileUrls = attachedFiles.map(file => ({
                name: file.name,
                type: file.type,
                url: URL.createObjectURL(file)
            }));
            
            addMessage('user', text, fileUrls);
            
            messageInput.value = '';
            const filesToSend = [...attachedFiles];
            attachedFiles = [];
            attachmentPreview.style.display = 'none';
            attachmentPreview.innerHTML = '';
            
            sendButton.disabled = true;
            isProcessing = true;
            sendButton.innerHTML = '<div class="loading-dots"><div class="dot"></div><div class="dot"></div><div class="dot"></div></div>';
            
            try {
                const lowerText = text.toLowerCase();
                if (lowerText.includes('ch√†o') || lowerText.includes('hello') || lowerText.includes('hi')) {
                    setTimeout(() => {
                        addMessage('bot', `Ch√†o em! Th·∫ßy/c√¥ r·∫•t vui ƒë∆∞·ª£c h·ªó tr·ª£ em h·ªçc m√¥n **${subjects[currentSubject].name}**. 
                                       \n\nEm c√≥ c√¢u h·ªèi g√¨ v·ªÅ b√†i h·ªçc h√¥m nay kh√¥ng?`);
                        sendButton.disabled = false;
                        isProcessing = false;
                        sendButton.innerHTML = '<i class="fas fa-paper-plane"></i>';
                    }, 500);
                    return;
                }
                
                if (!model) {
                    throw new Error('AI ch∆∞a s·∫µn s√†ng');
                }
                
                if (filesToSend.length > 0) {
                    const hasPDF = filesToSend.some(f => f.name.endsWith('.pdf'));
                    if (hasPDF) {
                        addMessage('bot', `üìö **ƒêang x·ª≠ l√Ω file PDF...**\nƒêang chuy·ªÉn PDF th√†nh ·∫£nh ƒë·ªÉ AI ƒë·ªçc n·ªôi dung. Vui l√≤ng ch·ªù!`);
                    } else {
                        addMessage('bot', `üìé **ƒêang ƒë·ªçc ${filesToSend.length} file ƒë√≠nh k√®m...**`);
                    }
                }
                
                const { images: processedImages, text: fileText } = await processFilesForAI(filesToSend);
                
                const hasImages = processedImages.length > 0;
                const hasPDF = filesToSend.some(f => f.name.endsWith('.pdf'));
                let prompt = preparePrompt(text, hasImages, hasPDF);
                
                if (fileText) {
                    prompt += `\n\n--- N·ªòI DUNG T·ª™ C√ÅC FILE VƒÇN B·∫¢N ---${fileText}`;
                }
                
                if (hasPDF) {
                    const pdfFiles = filesToSend.filter(f => f.name.endsWith('.pdf'));
                    prompt += `\n\n--- TH√îNG TIN PDF ---\n`;
                    pdfFiles.forEach(pdf => {
                        prompt += `‚Ä¢ ${pdf.name} (ƒë√£ chuy·ªÉn th√†nh ${processedImages.length} ·∫£nh ƒë·ªÉ ph√¢n t√≠ch)\n`;
                    });
                }
                
                let result;
                if (processedImages.length > 0) {
                    console.log(`G·ª≠i ${processedImages.length} ·∫£nh cho Gemini...`);
                    result = await model.generateContent([prompt, ...processedImages]);
                } else {
                    result = await model.generateContent(prompt);
                }
                
                const response = await result.response;
                let botResponse = response.text();
                
                if (botResponse.length > 1500) {
                    botResponse += `\n\n---\n*üìù ƒê√¢y l√† ph√¢n t√≠ch chi ti·∫øt. Em c√≥ ch·ªó n√†o c·∫ßn gi·∫£i th√≠ch th√™m kh√¥ng?*`;
                }
                
                addMessage('bot', botResponse);
                
            } catch (error) {
                console.error('L·ªói khi g·ª≠i tin nh·∫Øn:', error);
                
                let errorMsg = '**Xin l·ªói, c√≥ l·ªói x·∫£y ra!**\n\n';
                
                if (error.message.includes('quota') || error.message.includes('limit')) {
                    errorMsg += '‚ö†Ô∏è **ƒê√£ v∆∞·ª£t qu√° gi·ªõi h·∫°n s·ª≠ d·ª•ng AI.**\n';
                    errorMsg += 'Vui l√≤ng th·ª≠ l·∫°i sau √≠t ph√∫t ho·∫∑c:\n';
                    errorMsg += '1. M√¥ t·∫£ b√†i t·∫≠p b·∫±ng l·ªùi\n';
                    errorMsg += '2. Ch·ª•p ·∫£nh r√µ n√©t thay v√¨ PDF\n';
                    errorMsg += '3. Chia nh·ªè file l·ªõn th√†nh nhi·ªÅu ph·∫ßn';
                } 
                else if (filesToSend.some(f => f.name.endsWith('.pdf'))) {
                    errorMsg += '**Kh√¥ng th·ªÉ ƒë·ªçc file PDF.**\n\n';
                    errorMsg += '**Gi·∫£i ph√°p thay th·∫ø:**\n';
                    errorMsg += '1. üì∏ **Ch·ª•p ·∫£nh m√†n h√¨nh** t·ª´ng trang PDF\n';
                    errorMsg += '2. ‚úÇÔ∏è **C·∫Øt file PDF** th√†nh trang nh·ªè h∆°n\n';
                    errorMsg += '3. üìù **Sao ch√©p n·ªôi dung** v√†o tin nh·∫Øn\n';
                    errorMsg += '4. üñºÔ∏è **Xu·∫•t PDF th√†nh ·∫£nh** tr∆∞·ªõc khi g·ª≠i';
                }
                else {
                    errorMsg += 'Vui l√≤ng th·ª≠ l·∫°i ho·∫∑c:\n';
                    errorMsg += '‚Ä¢ Ki·ªÉm tra k·∫øt n·ªëi m·∫°ng\n';
                    errorMsg += '‚Ä¢ G·ª≠i l·∫°i file v·ªõi k√≠ch th∆∞·ªõc nh·ªè h∆°n\n';
                    errorMsg += '‚Ä¢ M√¥ t·∫£ b√†i t·∫≠p b·∫±ng l·ªùi';
                }
                
                addMessage('bot', errorMsg);
                showNotification('C√≥ l·ªói x·∫£y ra', 'error');
            }
            
            sendButton.disabled = false;
            isProcessing = false;
            sendButton.innerHTML = '<i class="fas fa-paper-plane"></i>';
        }

        // ========== UI FUNCTIONS ==========

        // Save chat history
        function saveChatHistory() {
            try {
                sessionStorage.setItem(`chatHistory_${currentUser.uid}_${currentSubject}`, JSON.stringify(chatHistory));
            } catch (error) {
                console.error('L·ªói khi l∆∞u l·ªãch s·ª≠ chat:', error);
            }
        }

        // Display chat history
        function displayChatHistory() {
            messagesContainer.innerHTML = '';
            
            const now = new Date();
            const welcomeDiv = document.createElement('div');
            welcomeDiv.className = 'message bot-message';
            welcomeDiv.innerHTML = `
                <div class="message-content">Ch√†o em! Th·∫ßy/c√¥ l√† tr·ª£ l√Ω AI h·ªçc t·∫≠p c·ªßa tr∆∞·ªùng THCS Nguy·ªÖn Tri Ph∆∞∆°ng.<br>Em c√≥ th·ªÉ h·ªèi b·∫•t c·ª© ƒëi·ªÅu g√¨ v·ªÅ m√¥n <strong>${subjects[currentSubject].name}</strong>,<br>g·ª≠i file b√†i t·∫≠p, ho·∫∑c y√™u c·∫ßu gi·∫£i th√≠ch chi ti·∫øt.</div>
                <div class="message-time">${now.toLocaleTimeString('vi-VN', { hour: '2-digit', minute: '2-digit' })}</div>
            `;
            messagesContainer.appendChild(welcomeDiv);
            
            chatHistory.forEach(item => {
                addMessageToDisplay(item.role, item.text, item.files || []);
            });
            
            setTimeout(() => {
                renderMathInElement(messagesContainer, {
                    delimiters: [
                        { left: "$$", right: "$$", display: true },
                        { left: "$", right: "$", display: false }
                    ],
                    throwOnError: false,
                    output: 'html'
                });
            }, 100);
        }

        // Process markdown
        function processMarkdown(text) {
            if (!text) return '';
            let html = marked.parse(text);
            return html;
        }

        // Add message to display
        function addMessageToDisplay(sender, text, files = []) {
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${sender}-message`;
            
            const now = new Date();
            const timeString = now.toLocaleTimeString('vi-VN', { 
                hour: '2-digit', 
                minute: '2-digit' 
            });
            
            let fileHtml = '';
            if (files && files.length > 0) {
                fileHtml = '<div class="file-attachment">';
                files.forEach(file => {
                    if (file.type && file.type.startsWith('image/')) {
                        fileHtml += `
                            <div>
                                <a href="#" onclick="viewImage('${file.url}')">
                                    <i class="fas fa-image"></i> ${file.name}
                                </a>
                                <img src="${file.url}" alt="${file.name}" class="file-preview">
                            </div>
                        `;
                    } else {
                        const icon = getFileIcon(file.type, file.name);
                        fileHtml += `
                            <a href="${file.url}" download="${file.name}" target="_blank">
                                ${icon} ${file.name}
                            </a>
                        `;
                    }
                });
                fileHtml += '</div>';
            }
            
            let htmlContent = '';
            if (sender === 'bot') {
                htmlContent = processMarkdown(text);
            } else {
                htmlContent = text.replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/\n/g, '<br>');
            }
            
            messageDiv.innerHTML = `
                <div class="message-content">${htmlContent}${fileHtml}</div>
                <div class="message-time">${timeString}</div>
            `;
            
            messagesContainer.appendChild(messageDiv);
            
            if (sender === 'bot') {
                setTimeout(() => {
                    renderMathInElement(messageDiv, {
                        delimiters: [
                            { left: "$$", right: "$$", display: true },
                            { left: "$", right: "$", display: false }
                        ],
                        throwOnError: false,
                        output: 'html'
                    });
                }, 50);
            }
            
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        // Add message v√† l∆∞u v√†o history
        function addMessage(sender, text, files = []) {
            addMessageToDisplay(sender, text, files);
            
            chatHistory.push({
                role: sender,
                text: text,
                timestamp: new Date().toISOString(),
                files: files.map(f => ({ name: f.name, type: f.type, url: f.url }))
            });
            
            if (chatHistory.length > 50) {
                chatHistory = chatHistory.slice(-50);
            }
            
            saveChatHistory();
        }

        // Get file icon
        function getFileIcon(fileType, fileName) {
            if (fileType && fileType.startsWith('image/')) {
                return '<i class="fas fa-image"></i>';
            } else if (fileType === 'application/pdf') {
                return '<i class="fas fa-file-pdf"></i>';
            } else if (fileType && (fileType.includes('word') || fileName.endsWith('.doc') || fileName.endsWith('.docx'))) {
                return '<i class="fas fa-file-word"></i>';
            } else if (fileType && (fileType.includes('powerpoint') || fileName.endsWith('.ppt') || fileName.endsWith('.pptx'))) {
                return '<i class="fas fa-file-powerpoint"></i>';
            } else if (fileType === 'text/plain' || fileName.endsWith('.txt')) {
                return '<i class="fas fa-file-alt"></i>';
            } else {
                return '<i class="fas fa-file"></i>';
            }
        }

        // View image in modal
        function viewImage(url) {
            const modal = document.createElement('div');
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0,0,0,0.9);
                display: flex;
                align-items: center;
                justify-content: center;
                z-index: 10000;
                cursor: pointer;
            `;
            
            modal.innerHTML = `
                <div style="position: relative; max-width: 95vw; max-height: 95vh;">
                    <img src="${url}" style="max-width: 100%; max-height: 100%; border-radius: 10px; display: block;">
                    <button onclick="this.parentElement.parentElement.remove()" 
                            style="position: absolute; top: -40px; right: 0; background: #f44336; color: white; border: none; width: 40px; height: 40px; border-radius: 50%; cursor: pointer; font-size: 1.2em; display: flex; align-items: center; justify-content: center;">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            `;
            
            modal.addEventListener('click', function(e) {
                if (e.target === modal) {
                    modal.remove();
                }
            });
            
            document.body.appendChild(modal);
        }

        // Preview text file
        function previewTextFile(file, text) {
            const previewDiv = document.createElement('div');
            previewDiv.className = 'file-preview-text';
            const previewText = text.length > 1000 ? text.substring(0, 1000) + '...' : text;
            previewDiv.textContent = previewText;
            return previewDiv;
        }

        // Show PDF preview
        async function showPDFPreview(file) {
            return new Promise((resolve) => {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const preview = document.createElement('div');
                    preview.className = 'pdf-preview';
                    preview.innerHTML = `
                        <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 5px;">
                            <i class="fas fa-file-pdf" style="color: #e63946;"></i>
                            <strong>${file.name}</strong>
                            <span style="font-size: 0.8em; color: #6c757d;">
                                (${(file.size / 1024).toFixed(1)} KB)
                            </span>
                        </div>
                        <div style="font-size: 0.8em; color: #6c757d;">
                            ‚ö° S·∫Ω ƒë∆∞·ª£c chuy·ªÉn th√†nh ·∫£nh ƒë·ªÉ AI ƒë·ªçc
                        </div>
                    `;
                    resolve(preview);
                };
                reader.readAsArrayBuffer(file);
            });
        }

        // Add attachment preview
        async function addAttachmentPreview(file) {
            const attachmentItem = document.createElement('div');
            attachmentItem.className = 'attachment-item';
            
            const icon = getFileIcon(file.type, file.name);
            const fileName = file.name.length > 25 ? file.name.substring(0, 22) + '...' : file.name;
            
            attachmentItem.innerHTML = `
                <div class="attachment-header">
                    <div style="display: flex; align-items: center; gap: 8px;">
                        ${icon}
                        <span style="font-weight: 500;">${fileName}</span>
                        <span style="font-size: 0.8em; color: #6c757d;">
                            (${(file.size / 1024).toFixed(1)} KB)
                        </span>
                    </div>
                    <button class="remove-attachment" onclick="removeAttachment(${attachedFiles.length - 1})">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            `;
            
            if (file.name.endsWith('.pdf')) {
                const pdfPreview = await showPDFPreview(file);
                attachmentItem.appendChild(pdfPreview);
            } else if (file.type === 'text/plain' || file.name.endsWith('.txt')) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const preview = previewTextFile(file, e.target.result);
                    attachmentItem.appendChild(preview);
                };
                reader.readAsText(file);
            }
            
            attachmentPreview.appendChild(attachmentItem);
        }

        // Remove attachment
        function removeAttachment(index) {
            attachedFiles.splice(index, 1);
            updateAttachmentPreview();
        }

        // Update attachment preview
        function updateAttachmentPreview() {
            attachmentPreview.innerHTML = '';
            
            attachedFiles.forEach((file, index) => {
                const attachmentItem = document.createElement('div');
                attachmentItem.className = 'attachment-item';
                
                const icon = getFileIcon(file.type, file.name);
                const fileName = file.name.length > 25 ? file.name.substring(0, 22) + '...' : file.name;
                
                attachmentItem.innerHTML = `
                    <div class="attachment-header">
                        <div style="display: flex; align-items: center; gap: 8px;">
                            ${icon}
                            <span style="font-weight: 500;">${fileName}</span>
                            <span style="font-size: 0.8em; color: #6c757d;">
                                (${(file.size / 1024).toFixed(1)} KB)
                            </span>
                        </div>
                        <button class="remove-attachment" onclick="removeAttachment(${index})">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                `;
                
                if (file.name.endsWith('.pdf')) {
                    const preview = document.createElement('div');
                    preview.className = 'pdf-preview';
                    preview.innerHTML = `
                        <div style="font-size: 0.8em; color: #6c757d;">
                            ‚ö° S·∫Ω ƒë∆∞·ª£c chuy·ªÉn th√†nh ·∫£nh ƒë·ªÉ AI ƒë·ªçc
                        </div>
                    `;
                    attachmentItem.appendChild(preview);
                } else if (file.type === 'text/plain' || file.name.endsWith('.txt')) {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        const preview = previewTextFile(file, e.target.result);
                        attachmentItem.appendChild(preview);
                    };
                    reader.readAsText(file);
                }
                
                attachmentPreview.appendChild(attachmentItem);
            });
            
            if (attachedFiles.length === 0) {
                attachmentPreview.style.display = 'none';
            } else {
                attachmentPreview.style.display = 'flex';
            }
        }

        // Show notification
        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed;
                top: 85px;
                right: 20px;
                padding: 12px 18px;
                background: ${type === 'error' ? '#f44336' : type === 'warning' ? '#ff9800' : '#4CAF50'};
                color: white;
                border-radius: 10px;
                box-shadow: 0 5px 15px rgba(0,0,0,0.2);
                z-index: 1000;
                animation: slideIn 0.3s ease;
                font-size: 0.9em;
                font-family: 'Quicksand', sans-serif;
            `;
            
            notification.innerHTML = `
                <div style="display: flex; align-items: center; gap: 10px;">
                    <i class="fas fa-${type === 'error' ? 'exclamation-circle' : type === 'warning' ? 'exclamation-triangle' : 'check-circle'}"></i>
                    <span>${message}</span>
                </div>
            `;
            
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.style.animation = 'slideOut 0.3s ease';
                setTimeout(() => notification.remove(), 300);
            }, 3000);
        }

        // ========== SUBJECT MANAGEMENT ==========

        // Load subject knowledge
        async function loadSubjectKnowledge() {
            if (!firestoreInitialized) return;
            
            try {
                const snapshot = await db.collection('subject_knowledge')
                    .where('subject', '==', currentSubject)
                    .limit(1)
                    .get();
                
                subjectKnowledge = {};
                
                snapshot.forEach(doc => {
                    const data = doc.data();
                    subjectKnowledge[currentSubject] = data.knowledge || '';
                });
                
                console.log(`‚úÖ ƒê√£ t·∫£i ki·∫øn th·ª©c cho m√¥n ${currentSubject}`);
            } catch (error) {
                console.warn('‚ö† Kh√¥ng th·ªÉ t·∫£i ki·∫øn th·ª©c t·ª´ Firestore:', error);
                subjectKnowledge = {};
            }
        }

        // Load homework data
        async function loadHomeworkData() {
            if (!firestoreInitialized) return;
            
            try {
                const snapshot = await db.collection('homework')
                    .where('subject', '==', currentSubject)
                    .limit(5)
                    .get();
                
                homeworkData = {};
                homeworkData[currentSubject] = [];
                
                snapshot.forEach(doc => {
                    const data = doc.data();
                    homeworkData[currentSubject].push({
                        question: data.question,
                        answer: data.answer,
                        difficulty: data.difficulty || 'medium'
                    });
                });
                
                console.log(`‚úÖ ƒê√£ t·∫£i b√†i t·∫≠p cho m√¥n ${currentSubject}`);
            } catch (error) {
                console.warn('‚ö† Kh√¥ng th·ªÉ t·∫£i b√†i t·∫≠p t·ª´ Firestore:', error);
                homeworkData = {};
            }
        }

        // Select subject
        function selectSubject(subject) {
            saveChatHistory();
            
            subjectButtons.forEach(btn => {
                btn.classList.toggle('active', btn.dataset.subject === subject);
            });
            
            currentSubject = subject;
            
            const subjectName = subjects[subject]?.name || subject;
            subjectInfo.innerHTML = `Ch√†o em! Th·∫ßy/c√¥ s·∫µn s√†ng h·ªó tr·ª£ em h·ªçc m√¥n <strong>${subjectName}</strong>. 
                                   Em c√≥ th·ªÉ h·ªèi b√†i, g·ª≠i file ho·∫∑c y√™u c·∫ßu b√†i t·∫≠p.`;
            
            const savedHistory = sessionStorage.getItem(`chatHistory_${currentUser.uid}_${currentSubject}`);
            if (savedHistory) {
                try {
                    chatHistory = JSON.parse(savedHistory);
                } catch (error) {
                    chatHistory = [];
                }
            } else {
                chatHistory = [];
            }
            
            loadSubjectKnowledge();
            loadHomeworkData();
            displayChatHistory();
            
            if (window.innerWidth <= 768) {
                hideSidebar();
            }
        }

        // ========== SIDEBAR FUNCTIONS ==========

        function showSidebar() {
            sidebar.classList.add('show');
            sidebarOverlay.classList.add('show');
            sidebarToggleIcon.classList.remove('fa-bars');
            sidebarToggleIcon.classList.add('fa-times');
        }

        function hideSidebar() {
            sidebar.classList.remove('show');
            sidebarOverlay.classList.remove('show');
            sidebarToggleIcon.classList.remove('fa-times');
            sidebarToggleIcon.classList.add('fa-bars');
        }

        // ========== EVENT HANDLERS ==========

        // Handle file selection
        fileInput.addEventListener('change', (e) => {
            const files = Array.from(e.target.files);
            
            const maxSize = 10 * 1024 * 1024;
            const validFiles = files.filter(file => file.size <= maxSize);
            
            if (validFiles.length < files.length) {
                showNotification('M·ªôt s·ªë file v∆∞·ª£t qu√° gi·ªõi h·∫°n 10MB v√† ƒë√£ b·ªã b·ªè qua.', 'warning');
            }
            
            validFiles.forEach(file => {
                attachedFiles.push(file);
                addAttachmentPreview(file);
            });
            
            if (attachedFiles.length > 0) {
                attachmentPreview.style.display = 'flex';
            }
            
            fileInput.value = '';
        });

        // Handle Enter key
        messageInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendMessage();
            }
        });

        // ========== APP INITIALIZATION ==========

        async function initializeApp() {
            // Add notification styles
            if (!document.querySelector('#notification-styles')) {
                const style = document.createElement('style');
                style.id = 'notification-styles';
                style.textContent = `
                    @keyframes slideIn {
                        from { transform: translateX(100%); opacity: 0; }
                        to { transform: translateX(0); opacity: 1; }
                    }
                    @keyframes slideOut {
                        from { transform: translateX(0); opacity: 1; }
                        to { transform: translateX(100%); opacity: 0; }
                    }
                `;
                document.head.appendChild(style);
            }
            
            initializeUser();
            
            setTimeout(() => {
                loadSubjectKnowledge();
                loadHomeworkData();
            }, 1000);
            
            subjectButtons.forEach(button => {
                button.addEventListener('click', () => {
                    selectSubject(button.dataset.subject);
                });
            });
            
            sidebarToggle.addEventListener('click', function() {
                if (sidebar.classList.contains('show')) {
                    hideSidebar();
                } else {
                    showSidebar();
                }
            });
            
            sidebarOverlay.addEventListener('click', hideSidebar);
            
            document.addEventListener('click', (e) => {
                if (window.innerWidth <= 768 && 
                    !sidebar.contains(e.target) && 
                    !sidebarToggle.contains(e.target) &&
                    sidebar.classList.contains('show')) {
                    hideSidebar();
                }
            });
            
            window.addEventListener('resize', function() {
                if (window.innerWidth > 768) {
                    hideSidebar();
                }
            });
            
            setTimeout(() => {
                messageInput.focus();
            }, 500);
            
            console.log('‚úÖ Chatbot ƒë√£ s·∫µn s√†ng v·ªõi h·ªó tr·ª£ PDF ‚Üí ·∫¢nh');
        }

        // ========== GLOBAL FUNCTIONS ==========

        function goToIndex() {
            window.location.href = 'index.html';
        }

        function logout() {
            if (auth) {
                auth.signOut().then(() => {
                    localStorage.removeItem('user');
                    Object.keys(sessionStorage).forEach(key => {
                        if (key.startsWith('chatHistory_')) {
                            sessionStorage.removeItem(key);
                        }
                    });
                    window.location.href = 'auth.html';
                }).catch(error => {
                    console.error('L·ªói ƒëƒÉng xu·∫•t:', error);
                    window.location.href = 'auth.html';
                });
            } else {
                window.location.href = 'auth.html';
            }
        }

        // Start the app
        document.addEventListener('DOMContentLoaded', initializeApp);
        
        // Make functions available globally
        window.viewImage = viewImage;
        window.removeAttachment = removeAttachment;
        window.logout = logout;
        window.goToIndex = goToIndex;
        window.sendMessage = sendMessage;
    </script>
</body>
</html>
